<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Consultas Internas - Galvão Drones</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230E5847'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h4v2h-4v4h-2v-4H7v-2h4V8z'%3E%3C/path%3E%3Cpath d='M13.25 7.15c-.24-.24-.58-.36-.92-.36s-.68.12-.92.36L8.4 9.16c-.24.24-.36.58-.36.92s-.12.68.36.92l.71.71c.24.24.58.36.92.36s-.68-.12.92-.36l2.93-2.93c-.24-.24-.36-.58-.36-.92s-.12-.68-.36-.92l-.71-.71zM10.75 16.85c.24.24.58.36.92.36s-.68-.12.92-.36l2.93-2.93c-.24-.24-.36-.58-.36-.92s-.12-.68-.36-.92l-.71-.71c-.24-.24-.58-.36-.92-.36s-.68.12-.92.36l-2.93 2.93c-.24.24-.36.24-.36.92s-.12.68.36.92l.71.71zM18.8 8.4l-.71-.71c-.24-.24-.58-.36-.92-.36s-.68.12-.92.36L13.3 9.77c-.24.24-.36.58-.36.92s-.12.68.36.92l.71.71c-.24.24-.58.36-.92.36s-.68-.12.92-.36l3.85-3.85c-.24-.24-.36-.58-.36.92s-.12-.68-.36-.92zM5.2 15.6l.71.71c-.24.24-.58.36-.92.36s-.68-.12-.92.36l3.85-3.85c-.24.24-.36.58-.36.92s-.12.68-.36.92l-.71-.71c-.24-.24-.58-.36-.92-.36s-.68.12-.92.36L5.2 14.68c-.24.24-.36.58-.36.92s-.12.68.36.92z'%3E%3C/path%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --primary-color: #EF7E13; /* Laranja Galvão Drones */
            --secondary-color: #0E5847; /* Verde Galvão Drones */
            --light-grey: #f4f7f6; /* Ligeiramente alterado para tom mais suave */
            --medium-grey: #ecf0f1;
            --dark-grey: #bdc3c7;
            --danger-color: #e74c3c;
            --whatsapp-color: #25D366;
            --instagram-color: #C13584;
            --youtube-color: #FF0000;
            --help-color: #5865F2;
        }
        body {
            font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--light-grey); color: #333;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; position: relative;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://images.pexels.com/photos/2246476/pexels-photo-2246476.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0.1; z-index: -1;
            transition: background-image 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        body.visitor-mode-bg::before {
            background-image: url('https://i.imgur.com/b3lg2eE.png'); background-size: contain;
            background-position: center center; background-repeat: no-repeat; opacity: 0.5;
        }
        .container { width: 100%; max-width: 1200px; margin: 20px; z-index: 1; }
        #login-screen {
            background-color: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%; max-width: 400px; text-align: center; transition: opacity 0.5s ease; margin: auto;
        }
        #company-logo { max-width: 300px; width: 80%; display: block; margin: 0 auto 10px auto; }
        #portal-subtitle { color: #555; margin-top: 0; margin-bottom: 40px; font-size: 1.2em; font-weight: 400; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; font-family: 'Roboto', sans-serif;
        }
        .action-button {
            width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none;
            border-radius: 5px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; margin-top: 10px;
        }
        .action-button:hover { opacity: 0.9; }
        #login-error { color: var(--danger-color); margin-top: 15px; font-weight: 500; display: none; }
        #visitor-mode-button { background-color: var(--dark-grey); }
        #visitor-mode-button:hover { background-color: #95a5a6; }
        #app-screen {
            display: none; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden; transition: opacity 0.5s ease;
        }
        header {
            background-color: var(--secondary-color); color: white; padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center; height: 60px;
            position: relative;
            z-index: 1000;
        }
        header > #nav-toggle-btn {
            display: none;
        }
        #profile-icon-container {
            width: 40px; height: 40px; border-radius: 50%; overflow: hidden; cursor: pointer;
            border: 2px solid white; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: transform 0.2s ease-in-out; order: 0; margin-right: 15px;
        }
        #profile-icon-container:hover { transform: scale(1.05); }
        #profile-icon { width: 100%; height: 100%; object-fit: cover; display: block; }
        .header-left { display: flex; align-items: center; gap: 10px; height: 100%; order: 1; flex-grow: 0; justify-content: flex-start; }
        .header-title-container { order: 2; flex-grow: 1; text-align: center; }
        header > div:last-child { order: 3; margin-left: 15px; }
        header h1 { margin: 0; font-size: 24px; }
        header #logout-button {
            background-color: var(--danger-color); color: white; border: none;
            padding: 8px 15px; border-radius: 5px; font-weight: 500; cursor: pointer;
            transition: background-color 0.3s; display: block;
        }
        header #logout-button:hover { background-color: #c0392b; }
        .visitor-header #welcome-message { display: none; }
        #change-password-link { display: none !important; }
        .app-body { display: flex; position: relative; min-height: calc(100vh - 60px); }
        nav {
            width: 200px; min-width: 200px; background-color: var(--medium-grey); padding: 20px 0;
            border-right: 1px solid var(--dark-grey); transition: transform 0.3s ease; box-sizing: border-box;
            display: flex; flex-direction: column; flex-shrink: 0;
        }
        .nav-item-group { width: 100%; position: relative; }
        .sub-nav { background-color: var(--dark-grey); padding-left: 10px; }
        .sub-nav-button { font-size: 0.95em; padding: 10px 20px; border-bottom: 1px solid #c0c0c0; }
        .sub-nav-button:last-child { border-bottom: none; }
        .sub-nav-button.active, .sub-nav-button:hover { background-color: #a0a0a0; color: white; }
        @media (max-width: 768px) {
            nav {
                position: fixed; top: 0; left: 0; height: 100vh; width: 250px; min-width: 250px;
                transform: translateX(-100%); z-index: 999; box-shadow: 2px 0 5px rgba(0,0,0,0.2);
                padding-top: 60px; /* Deixa espaço para o header fixo */
                border-right: 1px solid var(--dark-grey);
            }
            nav.nav-open { transform: translateX(0); }
            .nav-header {
                display: flex; position: absolute; top: 0; width: 100%; height: 60px;
                background-color: var(--secondary-color); color: white; padding: 15px 20px;
                box-sizing: border-box; align-items: center;
            }
            .nav-header #nav-toggle-btn-close { font-size: 24px; background: none; border: none; color: white; cursor: pointer; padding: 0 10px; }
            .nav-header span { flex-grow: 1; text-align: center; margin-left: -20px; font-size: 1.2em; }
            .app-body { flex-direction: column; min-height: calc(100vh - 60px); }
            main { width: 100%; box-sizing: border-box; }
            header {
                padding: 10px 15px;
                position: sticky; /* Mantém o cabeçalho fixo no topo */
                top: 0;
                z-index: 1001;
                display: flex;
                align-items: center;
            }
            header h1 { font-size: 20px; }
            header > #nav-toggle-btn {
                display: block;
                order: -1; /* Força o botão a ser o primeiro elemento visual */
                margin-right: 10px; /* Espaçamento após o botão */
                font-size: 24px;
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                padding: 0;
            }
            header > #profile-icon-container { order: 0; margin-right: 10px; } /* Ajusta ordem */
            header > .header-left { order: 1; flex-grow: 1; justify-content: flex-start; } /* Ajusta ordem */
            header > .header-title-container { order: 2; flex-grow: 0; text-align: left; margin-left: auto; } /* Ajusta ordem */
            header > div:last-child { order: 3; } /* Ajusta ordem */

            #welcome-message {
                margin-left: 0; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                flex-shrink: 1; min-width: 0;
            }
            #profile-icon-container { margin-left: 5px; width: 35px; height: 35px; }
        }
        nav button {
            display: block; width: 100%; padding: 15px 20px; background: none; border: none;
            text-align: left; font-size: 16px; cursor: pointer; border-bottom: 1px solid #ddd;
            transition: background-color 0.3s, color 0.3s;
        }
        nav button.active, nav button:hover { background-color: var(--dark-grey); color: var(--secondary-color); font-weight: 700; }
        .nav-header {
            display: none; align-items: center; padding: 15px 20px;
            background-color: var(--dark-grey); color: var(--secondary-color); font-weight: 700;
        }
        .nav-header span { margin-left: 10px; }
        main {
            flex-grow: 1; padding: 30px; max-height: calc(100vh - 60px);
            overflow-y: auto; position: relative; transition: margin-left 0.3s ease;
        }
        @media (max-width: 768px) {
            main { padding: 20px; max-height: calc(100vh - 60px); width: 100%; }
            .header-left { gap: 10px; flex-grow: 1; }
            #welcome-message { margin-left: 0; flex-grow: 1; }
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .content-section h2, .content-section h3 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; color: var(--secondary-color); }
        .content-section h3 { border-bottom: 1px solid var(--dark-grey); font-size: 1.2em; margin-top: 30px; }
        #settings-options-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-top: 30px;
        }
        #settings-options-grid .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        #settings-options-grid .card h3 { color: var(--primary-color); font-size: 1.5em; margin-bottom: 10px; border-bottom: none; }
        #settings-options-grid .card p { font-size: 0.9em; color: #666; }
        .back-to-settings-button {
            background-color: var(--dark-grey); color: white; border: none; padding: 10px 15px;
            border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.3s;
            margin-bottom: 20px; display: inline-block; width: auto;
        }
        .back-to-settings-button:hover { background-color: #95a5a6; }
        .search-bar { margin-bottom: 20px; position: relative; }
        .search-bar input {
            width: 100%; padding: 12px 12px 12px 40px; font-size: 16px; border-radius: 5px;
            border: 1px solid #ccc; box-sizing: border-box;
        }
        .search-bar::before {
            content: '🔎'; position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; opacity: 0.6;
        }
        .card {
            position: relative; border: 1px solid #ddd; padding: 20px; margin-bottom: 15px;
            border-radius: 5px; transition: box-shadow 0.3s; z-index: 1;
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("logo.png"); background-size: 50%; background-position: center;
            background-repeat: no-repeat; opacity: 0.15; z-index: -1; border-radius: 5px;
        }
        .card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h3 { margin-top: 0; color: var(--secondary-color); border: none; font-size: 1.3em; }
        .product-card { border-left: 5px solid var(--primary-color); }
        .supplier-card { border-left: 5px solid var(--secondary-color); }
        .info-card { border-left: 5px solid var(--secondary-color); }
        .product-spec { white-space: pre-wrap; line-height: 1.6; font-size: 0.95em; }
        .price { font-size: 1.2em; font-weight: 700; color: #27ae60; }
        .cost-price { font-size: 1.1em; font-weight: 700; color: var(--danger-color); background-color: #fdd; padding: 5px; border-radius: 4px; display: inline-block; margin-top: 10px; }
        .supplier-info { font-size: 0.9em; font-weight: 500; color: var(--secondary-color); background-color: #e8f8f5; padding: 5px 8px; border-radius: 4px; display: inline-block; margin-top: 10px; margin-left: 10px;}
        .product-suppliers-list { list-style: none; padding: 0; margin: 10px 0 0 0; font-size: 0.9em; }
        .product-suppliers-list li {
            background-color: #f8f8f8; padding: 5px 10px; border-radius: 3px;
            margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee;
        }
        .product-suppliers-list li .supplier-name-link { color: var(--secondary-color); text-decoration: none; font-weight: bold; }
        .product-suppliers-list li .cost-value { color: var(--danger-color); font-weight: 500; }
        .action-buttons-container { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .action-buttons-container button, .action-buttons-container a.action-button {
            color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;
            font-weight: 500; transition: background-color 0.3s; font-size: 0.9em; text-decoration: none;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .gemini-button { background-color: var(--secondary-color); }
        .whatsapp-button { background-color: var(--whatsapp-color); }
        .instagram-button { background-color: var(--instagram-color); }
        .youtube-button { background-color: var(--youtube-color); }
        .google-maps-button { background-color: #4285F4; }
        .help-button { background-color: var(--help-color); }
        .action-buttons-container button:hover, .action-buttons-container a.action-button:hover { opacity: 0.9; }
        .calculator-container { margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--dark-grey); }
        .payment-method-selector label { display: inline-block; margin-right: 15px; cursor: pointer; font-size: 0.95em; }
        .payment-method-selector input { margin-right: 5px; }
        .installments-container { margin-top: 10px; }
        .calculate-product-btn { background-color: var(--secondary-color); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 10px;}
        .product-calculator-result, #general-calculator-result { margin-top: 15px; font-size: 1.1em; color: var(--secondary-color); background-color: #eaf5ff; padding: 15px; border-radius: 5px; }
        .result-vista { font-weight: bold; }
        .result-parcelado { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--dark-grey); }
        .result-parcelado small { font-size: 0.9em; font-weight: normal; color: #555; }
        .discount-option { margin-top: 10px; display: flex; align-items: center; gap: 10px; position: relative; }
        .discount-option input[type="number"] {
            width: 80px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;
            background-color: transparent; position: relative; z-index: 1;
        }
        .discount-option label { margin-bottom: 0; }
        .discount-option::after {
            content: "max. 15%"; position: absolute; left: 105px; color: #ccc;
            font-size: 0.8em; opacity: 0.8; pointer-events: none; white-space: nowrap; transform: translateY(2px); z-index: 0;
        }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #scroll-to-top { position: fixed; bottom: 20px; right: 30px; z-index: 99; border: none; outline: none; background-color: var(--primary-color); color: white; cursor: pointer; padding: 12px 15px; border-radius: 50%; font-size: 18px; display: none; }
        #temp-user-list-container { margin-top: 30px; }
        .temp-user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--medium-grey); }
        .temp-user-item:last-child { border-bottom: none; }
        .user-info p { margin: 0; }
        .user-info p small { color: #555; }
        .user-actions button { margin-left: 10px; padding: 5px 10px; border-radius: 4px; border: none; color: white; cursor: pointer; }
        .edit-btn { background-color: var(--primary-color); }
        .delete-btn { background-color: var(--danger-color); }
        .hidden { display: none !important; }
        #ai-chat-button {
            position: fixed; bottom: 90px; right: 30px; z-index: 99; border: none; outline: none;
            background-color: var(--secondary-color); color: white; cursor: pointer;
            padding: 15px 18px; border-radius: 50%; font-size: 24px; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: background-color 0.3s, transform 0.3s;
        }
        #ai-chat-button:hover { background-color: #0A4538; transform: translateY(-3px); }
        #ai-chat-button:active { transform: translateY(0); }
        #ai-chat-modal .modal-content { max-width: 700px; text-align: left; }
        #ai-chat-modal-body { text-align: left; }
        #ai-question-input {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
            box-sizing: border-box; font-size: 1em; margin-bottom: 15px;
        }
        #submit-ai-question { width: auto; padding: 10px 20px; font-size: 1em; }
        #ai-response-area { white-space: pre-wrap; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        #supplier-password-modal .modal-content { max-width: 400px; text-align: center; }
        #supplier-password-modal .input-group input { text-align: center; }
        #supplier-password-modal .error-message { color: var(--danger-color); margin-top: 10px; display: none; }
        #change-password-modal .modal-content { max-width: 450px; text-align: center; }
        #change-password-modal .input-group { margin-bottom: 15px; }
        #change-password-modal .input-group label { font-size: 0.9em; }
        #change-password-modal .error-message { color: var(--danger-color); margin-top: 10px; font-weight: 500; display: none; }
        #change-password-modal .success-message { color: var(--secondary-color); margin-top: 10px; font-weight: 500; display: none; }
        #profile-section .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        #profile-section .profile-pic-large { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #profile-section .profile-info h3 { margin: 0; font-size: 1.8em; color: var(--secondary-color); border-bottom: none; }
        #profile-section .profile-info p { margin: 5px 0; font-size: 1.1em; color: #555; }
        #profile-section .profile-edit-form .input-group { margin-bottom: 15px; }
        #profile-section .profile-edit-form .action-button { width: auto; padding: 10px 20px; margin-right: 10px; }
        #profile-section .profile-edit-form .action-button.secondary { background-color: var(--dark-grey); }
        #profile-section .profile-edit-form .action-button.secondary:hover { background-color: #95a5a6; }
        #profile-section .profile-feedback { margin-top: 15px; font-weight: bold; }
        #profile-section .profile-pic-upload-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #profile-section .profile-pic-upload-container input[type="file"] { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #profile-section .profile-pic-upload-container button { padding: 8px 15px; background-color: var(--secondary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        #whatsapp-modal .modal-content { max-width: 500px; text-align: left; }
        #whatsapp-modal textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
            box-sizing: border-box; font-size: 1em; min-height: 120px; margin-bottom: 15px;
        }
        #whatsapp-modal .profile-info-options { margin-bottom: 15px; }
        #whatsapp-modal .profile-info-options label { display: block; margin-bottom: 8px; font-weight: normal; font-size: 0.95em; }
        #whatsapp-modal .profile-info-options input[type="checkbox"] { margin-right: 8px; }
        #whatsapp-modal .action-button-group { display: flex; justify-content: flex-end; gap: 10px; }
        #whatsapp-modal .action-button-group .action-button { width: auto; }
        #whatsapp-modal .action-button-group .cancel-button { background-color: var(--dark-grey); }
        #whatsapp-modal .action-button-group .cancel-button:hover { background-color: #95a5a6; }

        /* Estilos para o novo modal de orçamento */
        #budget-modal .modal-content { max-width: 500px; }
        #budget-modal .modal-body-content div { margin-bottom: 15px; }
        #budget-modal .modal-body-content select, #budget-modal .modal-body-content textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;
        }
        #budget-modal .modal-body-content textarea { min-height: 100px; }
        #budget-modal .supplier-contact-info {
            display: flex; align-items: center; justify-content: space-between;
            background-color: var(--light-grey); padding: 10px; border-radius: 5px; margin-top: 15px;
        }
        #budget-modal .supplier-contact-info img { width: 40px; height: 40px; margin-right: 10px; }
        #budget-modal .supplier-contact-info .whatsapp-button { width: auto; margin-top: 0; }

        /* Estilos para os checkboxes do modal de orçamento */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal; /* Sobrescreve o estilo default de label */
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
            width: auto; /* Para não pegar o width: 100% de input-group input */
            padding: 0; /* Para não pegar o padding de input-group input */
            height: auto; /* Para não pegar o height de input-group input */
            box-sizing: content-box; /* Garante que padding e border não aumentem o tamanho */
        }

        .supplier-contacts-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .supplier-contacts-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-supplier-button {
            background-color: var(--dark-grey);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: auto; /* Empurra o botão para a direita */
            transition: background-color 0.3s;
        }

        .edit-supplier-button:hover {
            background-color: #95a5a6;
        }

        /* Modal para criar/editar fornecedor */
        #manage-supplier-modal .modal-content {
            max-width: 600px;
            text-align: left;
        }

        #manage-supplier-modal .input-group {
            margin-bottom: 10px;
        }

        #manage-supplier-modal .input-group label {
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        #manage-supplier-modal .checkbox-group label {
            font-size: 0.9em;
        }

        #manage-supplier-modal .contact-entry {
            border: 1px solid var(--medium-grey);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            position: relative;
        }

        #manage-supplier-modal .remove-contact-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 0.8em;
            cursor: pointer;
        }

        #manage-supplier-modal .add-contact-button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Modal de Busca para Alterar Fornecedor */
        #edit-supplier-search-modal .modal-content {
            max-width: 450px;
        }
        #edit-supplier-search-results-modal li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #edit-supplier-search-results-modal li:hover {
            background-color: var(--light-grey);
        }
        /* Novas regras para o botão de filtro e o modal de filtro */
        .filter-sort-button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 15px;
            width: auto;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .filter-sort-button:hover {
            background-color: #0A4538;
        }

        #filter-sort-modal .modal-content {
            max-width: 400px;
            margin: 10vh auto; /* Para ficar mais acima na tela */
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            border: none; /* Remove a borda padrão do modal */
        }
        #filter-sort-modal .modal-body-content {
            padding: 10px;
        }
        #filter-sort-modal .modal-body-content h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--medium-grey);
            padding-bottom: 5px;
        }
        #filter-sort-modal .filter-options,
        #filter-sort-modal .sort-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        #filter-sort-modal .filter-options button,
        #filter-sort-modal .sort-options button {
            background-color: var(--medium-grey);
            color: var(--secondary-color);
            border: 1px solid var(--dark-grey);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
        }
        #filter-sort-modal .filter-options button.active,
        #filter-sort-modal .sort-options button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: bold;
        }
        #filter-sort-modal .filter-options button:hover,
        #filter-sort-modal .sort-options button:hover {
            background-color: var(--light-grey);
            border-color: var(--primary-color);
        }
        #filter-sort-modal .search-filter-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-screen">
            <img src="https://i.imgur.com/pgwtkKq.png" alt="Logotipo Galvão Drones" id="company-logo">
            <h2 id="portal-subtitle">Portal Interno</h2>
            <div class="input-group"><label for="username">Usuário</label><input type="text" id="username" placeholder="Digite seu nome"></div>
            <div class="input-group"><label for="password">Senha</label><input type="password" id="password" placeholder="Sua senha"></div>
            <button id="login-button" class="action-button">Entrar</button>
            <button id="visitor-mode-button" class="action-button">Modo Visitante</button>
            <p id="login-error">Usuário ou senha inválidos.</p>
        </div>

        <div id="app-screen">
            <header>
                <button id="nav-toggle-btn" class="nav-toggle-btn">☰</button>
                <div id="profile-icon-container">
                    <img id="profile-icon" src="https://i.imgur.com/8Yd00YF.png" alt="Foto de Perfil">
                </div>
                <div class="header-left">
                    <span id="welcome-message"></span>
                </div>
                <div class="header-title-container">
                    <h1>Portal Interno</h1>
                </div>
                <div>
                    <button id="logout-button">Sair</button>
                </div>
            </header>
            <div class="app-body">
                <nav>
                    <div class="nav-header">
                        <button id="nav-toggle-btn-close" class="nav-toggle-btn">✕</button>
                        <span>Menu</span>
                    </div>
                    <button class="nav-button" data-section="products-section" id="products-nav-button" style="order: 1;">Produtos</button>
                    <button class="nav-button" data-section="calculator-section" id="calculator-nav-button" style="order: 2;">Calculadora</button>
                    <button class="nav-button" data-section="suppliers-section" id="suppliers-nav-button" style="order: 3;">Fornecedores</button>

                    <div class="nav-item-group" style="order: 4;">
                        <button class="nav-button" data-section="settings-section" id="settings-nav-button">Configurações</button>
                        <div class="sub-nav" id="settings-sub-nav" style="display: none;">
                            <button class="nav-button sub-nav-button" data-section="manage-users-section" id="manage-users-nav-button">Gerir Usuários</button>
                            <button class="nav-button sub-nav-button" data-section="create-product-section" id="create-product-nav-button">Criar Produto</button>
                            <button class="nav-button sub-nav-button" data-section="edit-product-section" id="edit-product-nav-button">Alterar Produto</button>
                        </div>
                    </div>

                    <button class="nav-button" data-section="drones-visitor-section" id="drones-nav-button" style="order: 5;">Drones</button>
                    <button class="nav-button" data-section="info-section" id="info-empresa-nav-button" style="order: 6;">Info Empresa</button>
                    <button class="nav-button" data-section="marketing-section" id="marketing-nav-button" style="order: 7;">Marketing</button>
                    <button class="nav-button hidden" data-section="profile-section" id="profile-nav-button" style="order: 8;">Meu Perfil</button>
                </nav>
                <main id="main-content">
                    <section id="products-section" class="content-section active">
                        <h2>Consulta de Produtos</h2>
                        <div class="search-bar"><input type="text" id="product-search" placeholder="Pesquisar por nome ou especificação..."></div>
                        <button id="open-product-filter-sort-modal" class="filter-sort-button">
                            ⚙️ Filtros e Ordenação
                        </button>
                        <div id="product-list"></div>
                    </section>
                    <section id="calculator-section" class="content-section">
                        <h2>Calculadora Geral</h2>
                        <div class="card">
                           <div class="input-group">
                                <label for="general-valor-base">Valor Base</label>
                                <input type="number" id="general-valor-base" class="input-full" placeholder="Digite o valor para simulação">
                           </div>
                           <div class="input-group">
                                <label>Forma de Pagamento</label>
                                <div id="general-payment-method-selector">
                                    <input type="radio" id="general-payment-vista" name="general-payment-method" value="vista" checked>
                                    <label for="general-payment-vista">À vista</label>
                                    <input type="radio" id="general-payment-parcelado" name="general-payment-method" value="parcelado">
                                    <label for="general-payment-parcelado">Parcelado</label>
                                </div>
                           </div>
                           <div class="discount-option hidden" id="general-discount-option">
                               <label for="general-discount-percentage">Desconto (%):</label>
                               <input type="number" id="general-discount-percentage" min="0" max="15" value="0">
                           </div>
                           <div class="input-group hidden" id="general-installments-container">
                                <label for="general-parcelas">Número de Parcelas</label>
                                <select id="general-parcelas">
                                    <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option>
                                </select>
                           </div>
                           <button id="general-calculate-button" class="action-button" style="width: auto; padding: 10px 20px;">Calcular</button>
                           <div id="general-calculator-result">O resultado da simulação aparecerá aqui.</div>
                          </div>
                    </section>
                    <section id="suppliers-section" class="content-section">
                        <h2>Fornecedores (Acesso Confidencial)</h2>
                        <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button id="open-budget-modal-button" class="action-button" style="width: auto;">Fazer Orçamento</button>
                            <button id="open-create-supplier-modal-button" class="action-button" style="width: auto; background-color: var(--secondary-color);">Criar Fornecedor</button>
                            <button id="open-edit-supplier-search-modal-button" class="action-button" style="width: auto; background-color: var(--secondary-color);">Alterar Fornecedor</button>
                        </div>
                        <button id="open-supplier-filter-sort-modal" class="filter-sort-button">
                            ⚙️ Filtros e Ordenação
                        </button>
                        <div id="supplier-list"></div>
                    </section>

                    <section id="settings-section" class="content-section">
                        <h2>Configurações do Sistema</h2>
                        <p>Selecione uma opção de configuração no menu lateral, ou clique nos atalhos abaixo:</p>
                        <div id="settings-options-grid"></div>
                    </section>

                    <section id="manage-users-section" class="content-section">
                        <button class="back-to-settings-button" onclick="window.switchTab('settings-section')">← Voltar para Configurações</button>
                        <h2>Gerir Usuários Temporários</h2>
                        <div class="card">
                            <h3>Criar Usuário Temporário</h3>
                            <form id="create-temp-user-form">
                                <div class="input-group"><label for="temp-username">Nome de Usuário</label><input type="text" id="temp-username" required></div>
                                <div class="input-group"><label for="temp-password">Senha</label><input type="text" id="temp-password" required></div>
                                <div class="input-group"><label for="temp-duration">Duração do Acesso</label><select id="temp-duration"><option value="1">1 Hora</option><option value="8">8 Horas</option><option value="24" selected>24 Horas</option><option value="72">72 Horas</option></select></div>
                                <button type="submit" class="action-button">Criar Usuário</button>
                                <p id="temp-user-feedback" style="margin-top: 15px; font-weight: bold;"></p>
                            </form>
                        </div>
                        <div id="temp-user-list-container">
                            <h3>Usuários Temporários Ativos</h3>
                            <div id="temp-user-list" class="card"></div>
                        </div>
                    </section>

                    <section id="create-product-section" class="content-section">
                        <button class="back-to-settings-button" onclick="window.switchTab('settings-section')">← Voltar para Configurações</button>
                        <h2>Criar Novo Produto</h2>
                        <div class="card">
                            <form id="create-product-form">
                                <div class="input-group"><label for="new-product-name">Nome do Produto</label><input type="text" id="new-product-name" required></div>
                                <div class="input-group"><label for="new-product-spec">Especificações</label><textarea id="new-product-spec" rows="5"></textarea></div>
                                <div class="input-group"><label for="new-product-sale-price">Preço de Venda (R$)</label><input type="number" id="new-product-sale-price" step="0.01" min="0" required></div>
                                <div class="input-group"><label for="new-product-cost-price">Preço de Custo (R$)</label><input type="number" id="new-product-cost-price" step="0.01" min="0"></div>
                                <div class="input-group">
                                    <label for="new-product-supplier">Fornecedor Principal</label>
                                    <select id="new-product-supplier">
                                        </select>
                                </div>
                                <button type="submit" class="action-button">Salvar Novo Produto</button>
                                <p id="create-product-feedback" style="margin-top: 15px; font-weight: bold;"></p>
                            </form>
                        </div>
                    </section>

                    <section id="edit-product-section" class="content-section">
                        <button class="back-to-settings-button" onclick="window.switchTab('settings-section')">← Voltar para Configurações</button>
                        <h2>Alterar Produto Existente</h2>
                        <div class="card">
                            <div class="input-group">
                                <label for="edit-product-search-input">Buscar Produto (ID ou Nome)</label>
                                <input type="text" id="edit-product-search-input" placeholder="Digite o ID ou nome do produto">
                                <button id="search-product-to-edit" class="action-button" style="width: auto; margin-top: 10px;">Buscar</button>
                            </div>
                            <div id="edit-product-search-results" style="margin-top: 15px;"></div>

                            <div id="edit-product-display" style="margin-top: 20px;">
                                <p>Use a busca acima para carregar os dados do produto.</p>
                            </div>
                            <form id="edit-product-form" class="hidden">
                                <input type="hidden" id="edit-product-id">
                                <div class="input-group"><label for="edit-product-name">Nome do Produto</label><input type="text" id="edit-product-name" required></div>
                                <div class="input-group"><label for="edit-product-spec">Especificações</label><textarea id="edit-product-spec" rows="5"></textarea></div>
                                <div class="input-group"><label for="edit-product-sale-price">Preço de Venda (R$)</label><input type="number" id="edit-product-sale-price" step="0.01" min="0" required></div>
                                <div class="input-group"><label for="edit-product-cost-price">Preço de Custo (R$)</label><input type="number" id="edit-product-cost-price" step="0.01" min="0"></div>
                                <div class="input-group">
                                    <label for="edit-product-supplier">Fornecedor Principal</label>
                                    <select id="edit-product-supplier">
                                        </select>
                                </div>
                                <button type="submit" class="action-button">Salvar Alterações</button>
                                <p id="edit-product-feedback" class="profile-feedback"></p>
                            </form>
                        </div>
                    </section>

                    <section id="drones-visitor-section" class="content-section">
                        <h2>Modelos de Drones</h2>
                        <div class="search-bar"><input type="text" id="drone-visitor-search" placeholder="Pesquisar por modelo ou especificação..."></div>
                        <div id="drone-visitor-list"></div>
                    </section>
                    <section id="info-section" class="content-section">
                        <h2>Informações da Empresa</h2>
                        <div class="card info-card">
                            <p><strong>Nome da Empresa:</strong> Galvão Drones</p>
                            <p id="cnpj-display-line"><strong>CNPJ:</strong> 60.102.179/0001-10</p>
                            <p><strong>Endereço:</strong> Rua 16, nº 304 – Setor Aeroviário, Goiânia – GO, CEP: 74435-240</p>
                            <p><a href="http://maps.google.com/maps?q=Rua+16,+n%C2%BA+304+%E2%80%93+Setor+Aerovi%C3%A1rio,+Goi%C3%A2nia+%E2%80%93+GO,+CEP%3A+74435-240" target="_blank" class="action-button google-maps-button" style="width: auto; padding: 10px 15px; margin-right: 10px;">Ver no Google Maps</a></p>
                            <p><strong>Contato:</strong> <span id="company-phone">(62) 3636-0668</span></p>
                            <div class="contact-buttons-container" style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                <a href="https://www.instagram.com/galvao_drones" target="_blank" class="action-button instagram-button" style="width: auto; padding: 10px 15px;">Instagram</a>
                                <a href="https://wa.me/556236360668" target="_blank" class="action-button whatsapp-button" id="company-whatsapp-link" style="width: auto; padding: 10px 15px;">WhatsApp</a>
                                <a href="https://www.youtube.com/channel/UC-K1rJ4_C7c_C7d_C7e_C7f" target="_blank" class="action-button youtube-button" style="width: auto; padding: 10px 15px;">YouTube</a>
                            </div>
                            <p><strong>Website:</strong> <a href="https://www.galvaodrones.com.br" target="_blank">www.galvaodrones.com.br</a></p>
                        </div>
                    </section>

                    <section id="profile-section" class="content-section">
                        <h2>Meu Perfil</h2>
                        <div class="card">
                            <div class="profile-header">
                                <img id="profile-pic-display" src="https://i.imgur.com/8Yd00YF.png" alt="Foto de Perfil">
                                <div class="profile-info">
                                    <h3 id="profile-display-name"></h3>
                                    <p id="profile-email"></p>
                                    <p id="profile-phone"></p>
                                </div>
                            </div>
                            <form id="profile-edit-form" class="profile-edit-form">
                                <h3>Alterar Dados</h3>
                                <div class="input-group">
                                    <label for="edit-display-name">Nome de Exibição</label>
                                    <input type="text" id="edit-display-name" required>
                                </div>
                                <div class="input-group">
                                    <label for="edit-email">Email</label>
                                    <input type="email" id="edit-email">
                                </div>
                                <div class="input-group">
                                    <label for="edit-phone">Celular para Atendimento (WhatsApp)</label>
                                    <input type="tel" id="edit-phone" placeholder="Ex: 62988887777">
                                </div>
                                <div class="input-group profile-pic-upload-container">
                                    <label for="edit-profile-pic">Alterar Foto de Perfil</label>
                                    <input type="file" id="edit-profile-pic" accept="image/*">
                                    <button type="button" id="upload-profile-pic-button">Carregar Foto</button>
                                </div>
                                <button type="submit" class="action-button">Salvar Alterações do Perfil</button>
                                <button type="button" id="open-change-password-modal" class="action-button secondary">Alterar Senha</button>
                                <p id="profile-feedback" class="profile-feedback"></p>
                            </form>
                        </div>
                    </section>

                    <section id="marketing-section" class="content-section">
                        <h2>Conteúdo para Marketing</h2>
                        <p>Aqui você encontra materiais visuais e informativos para suas campanhas de marketing da Galvão Drones.</p>
                        <div class="marketing-content">
                            <div class="marketing-item">
                                <h3>Logo Oficial Galvão Drones (Cor Padrão - PNG)</h3>
                                <img src="https://i.imgur.com/pgwtkKq.png" alt="Logo Galvão Drones Cor Padrão">
                                <a href="https://i.imgur.com/pgwtkKq.png" download="galvao_drones_logo_padrao.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Logo Oficial Galvão Drones (Fundo Transparente - PNG)</h3>
                                <img src="https://i.imgur.com/ZsH8VeQ.png" alt="Logo Galvão Drones Fundo Transparente">
                                <a href="https://i.imgur.com/ZsH8VeQ.png" download="galvao_drones_logo_transparente.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Logo Galvão Drones (Versão Clara - PNG)</h3>
                                <img src="https://i.imgur.com/0CpzT9r.png" alt="Logo Galvão Drones Versão Clara">
                                <a href="https://i.imgur.com/0CpzT9r.png" download="galvao_drones_logo_clara.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Logo Galvão Drones (Versão Esverdeada - PNG)</h3>
                                <img src="https://i.imgur.com/UX00mxn.png" alt="Logo Galvão Drones Versão Esverdeada">
                                <a href="https://i.imgur.com/UX00mxn.png" download="galvao_drones_logo_esverdeada.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Logo Galvão Drones (Fundo Laranja - JPG)</h3>
                                <img src="https://i.imgur.com/b9gygL7.png" alt="Logo Galvão Drones Fundo Laranja">
                                <a href="https://i.imgur.com/b9gygL7.png" download="galvao_drones_logo_fundo_laranja.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Logo Galvão Drones (Fundo Preto - JPG)</h3>
                                <img src="https://i.imgur.com/5dpZZuY.png" alt="Logo Galvão Drones Fundo Preto">
                                <a href="https://i.imgur.com/5dpZZuY.png" download="galvao_drones_logo_fundo_preto.png" class="download-button">Baixar Logo PNG</a>
                            </div>
                            <div class="marketing-item">
                                <h3>Guia de Estilo da Marca Galvão Drones</h3>
                                <p>Um PDF completo com diretrizes de uso da marca, paleta de cores e tipografia.</p>
                                <a href="https://drive.google.com/uc?export=download&id=1bcg8UuCBSfaPB5ktacHz5KfWgGY5ir-a" download="guia_de_estilo_galvao_drones.pdf" class="download-button">Baixar Guia de Estilo (PDF)</a>
                            </div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <button id="scroll-to-top" title="Voltar ao topo">⬆</button>
    <button id="ai-chat-button" title="Falar com a IA">🤖</button>

    <div id="main-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h3 id="modal-title">Aviso</h3>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="ai-chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h3>Fale com a IA da Galvão Drones</h3>
            <div id="ai-chat-modal-body">
                <div class="input-group">
                    <label for="ai-question-input">Qual a sua pergunta?</label>
                    <textarea id="ai-question-input" rows="4" placeholder="Ex: Quais as principais diferenças entre o DJI Mini 4 Pro e o Air 3S?"></textarea>
                </div>
                <button id="submit-ai-question" class="action-button">Enviar Pergunta</button>
                <div class="loader" style="display: none;"></div>
                <div id="ai-response-area" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <div id="supplier-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="supplier-password-close-button">×</span>
            <h3>Acesso Restrito</h3>
            <p>Por favor, digite a senha para acessar as informações de fornecedores:</p>
            <div class="input-group">
                <input type="password" id="supplier-access-password" placeholder="Digite a senha">
            </div>
            <button id="submit-supplier-password" class="action-button">Acessar</button>
            <p id="supplier-password-error" class="error-message">Senha incorreta.</p>
        </div>
    </div>

    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="change-password-close-button">×</span>
            <h3 id="change-password-modal-title">Alterar Senha</h3>
            <p id="change-password-message">Por favor, defina uma nova senha para sua conta.</p>
            <div class="input-group">
                <label for="new-password">Nova Senha (mín. 6 dígitos)</label>
                <input type="password" id="new-password">
            </div>
            <div class="input-group">
                <label for="confirm-new-password">Confirmar Nova Senha</label>
                <input type="password" id="confirm-new-password">
            </div>
            <button id="submit-change-password" class="action-button">Salvar Nova Senha</button>
            <p id="change-password-error" class="error-message">Senhas não conferem ou são muito curtas.</p>
            <p id="change-password-success" class="success-message">Senha alterada com sucesso!</p>
        </div>
    </div>

    <div id="whatsapp-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="whatsapp-close-button">×</span>
            <h3>Personalizar Mensagem do WhatsApp</h3>
            <textarea id="whatsapp-message-input"></textarea>
            <div class="profile-info-options">
                <h4>Incluir Informações do Perfil:</h4>
                <label>
                    <input type="checkbox" id="include-display-name"> Nome de Exibição (<span id="whatsapp-display-name-preview"></span>)
                </label>
                <label>
                    <input type="checkbox" id="include-email"> Email (<span id="whatsapp-email-preview"></span>)
                </label>
                <label>
                    <input type="checkbox" id="include-phone"> Celular para Atendimento (<span id="whatsapp-phone-preview"></span>)
                </label>
            </div>
            <div class="action-button-group">
                <button id="send-whatsapp-button" class="action-button whatsapp-button">Enviar via WhatsApp</button>
                <button id="cancel-whatsapp-button" class="action-button cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="budget-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="budget-close-button">×</span>
            <h3>Solicitar Orçamento ao Fornecedor</h3>
            <div id="budget-modal-body-content" class="modal-body-content">
                <div class="input-group">
                    <label>Categoria do Drone</label>
                    <div class="checkbox-group" id="drone-category-checkboxes">
                        <label><input type="checkbox" name="drone-category" value="Consumer"> Consumer</label>
                        <label><input type="checkbox" name="drone-category" value="Enterprise"> Enterprise</label>
                        <label><input type="checkbox" name="drone-category" value="Agriculture"> Agriculture</label>
                    </div>
                </div>

                <div class="input-group hidden" id="item-type-group">
                    <label>Tipo de Item</label>
                    <div class="checkbox-group" id="item-type-checkboxes">
                        <label><input type="checkbox" name="item-type" value="Equipamentos"> Equipamentos</label>
                        <label><input type="checkbox" name="item-type" value="Pecas"> Peças</label>
                    </div>
                </div>

                <div class="input-group hidden" id="equipment-details-group">
                    <label for="equipment-details">Modelos, quantidades e baterias (Ex: DJI Mini 4 Pro x2, Baterias x4)</label>
                    <textarea id="equipment-details" rows="5" placeholder="Descreva os modelos, quantidades e baterias..."></textarea>
                </div>

                <div class="input-group hidden" id="spare-parts-details-group">
                    <label for="spare-parts-details">Peças necessárias (Ex: Hélices DJI Mini 3 x4, Motor x1)</label>
                    <textarea id="spare-parts-details" rows="5" placeholder="Descreva as peças e quantidades..."></textarea>
                </div>

                <div class="input-group hidden" id="supplier-select-group">
                    <label>Selecione o(s) Fornecedor(es)</label>
                    <div class="checkbox-group" id="budget-supplier-checkboxes">
                        </div>
                </div>

                <div id="selected-supplier-contact" class="supplier-contact-info hidden">
                    <span id="selected-supplier-name-display"></span>
                    <a href="#" class="action-button whatsapp-button" id="send-budget-whatsapp">
                        <img src="https://i.imgur.com/XF9rY8D.png" alt="WhatsApp" style="height: 20px; width: 20px; margin-right: 5px; vertical-align: middle;">
                        Solicitar Orçamento
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="manage-supplier-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="manage-supplier-close-button">×</span>
            <h3 id="manage-supplier-modal-title"></h3>
            <form id="manage-supplier-form">
                <input type="hidden" id="supplier-id-to-edit">
                <div class="input-group">
                    <label for="supplier-name">Nome do Fornecedor</label>
                    <input type="text" id="supplier-name" required>
                </div>
                <div class="input-group">
                    <label for="supplier-details">Detalhes</label>
                    <textarea id="supplier-details" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label for="supplier-payment">Condições de Pagamento</label>
                    <textarea id="supplier-payment" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label for="supplier-products">Produtos Principais</label>
                    <input type="text" id="supplier-products">
                </div>
                <div class="input-group">
                    <label>Categorias</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="supplier-category" value="Consumer"> Consumer</label>
                        <label><input type="checkbox" name="supplier-category" value="Enterprise"> Enterprise</label>
                        <label><input type="checkbox" name="supplier-category" value="Agriculture"> Agriculture</label>
                        <label><input type="checkbox" name="supplier-category" value="Equipamentos"> Equipamentos</label>
                        <label><input type="checkbox" name="supplier-category" value="Pecas"> Peças</label>
                    </div>
                </div>

                <h4>Contatos:</h4>
                <div id="supplier-contacts-container">
                    </div>
                <button type="button" class="add-contact-button" id="add-supplier-contact-button">Adicionar Contato</button>

                <button type="submit" class="action-button" id="save-supplier-button" style="margin-top: 20px;">Salvar Fornecedor</button>
                <p id="manage-supplier-feedback" style="margin-top: 15px; font-weight: bold;"></p>
            </form>
        </div>
    </div>

    <div id="edit-supplier-search-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="edit-supplier-search-close-button">×</span>
            <h3>Buscar Fornecedor para Alterar</h3>
            <div class="input-group">
                <label for="edit-supplier-search-input-modal">Nome do Fornecedor</label>
                <input type="text" id="edit-supplier-search-input-modal" placeholder="Digite o nome do fornecedor">
            </div>
            <button id="search-supplier-to-edit-modal-button" class="action-button">Buscar</button>
            <div id="edit-supplier-search-results-modal" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="filter-sort-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="filter-sort-close-button">×</span>
            <h3 id="filter-sort-modal-title">Filtros e Ordenação</h3>
            <div class="modal-body-content">
                <input type="text" id="filter-sort-search-input" class="search-filter-input" placeholder="Pesquisar por palavra-chave...">

                <h4 id="sort-options-title">Ordenar por:</h4>
                <div class="sort-options" id="filter-sort-order-buttons">
                    </div>

                <h4 id="category-options-title">Filtrar por Categoria:</h4>
                <div class="filter-options" id="filter-sort-category-buttons">
                    </div>

                <button id="apply-filter-sort-button" class="action-button" style="width: auto; margin-top: 20px;">Aplicar Filtros</button>
            </div>
        </div>
    </div>
window.onload = function() {
    // Dados para simulação (substitua por dados reais se necessário)
    let currentUser = null;
    let users = [
        { username: "mikhaell", password: "123", role: "admin", displayName: "Mikhaell Galvão", email: "mikhaell@galvaodrones.com.br", phone: "62988887777", profilePic: "https://i.imgur.com/8Yd00YF.png" },
        { username: "hevelyn", password: "123", role: "user", displayName: "Hevelyn Galvão", email: "hevelyn@galvaodrones.com.br", phone: "62999998888", profilePic: "https://i.imgur.com/8Yd00YF.png" },
        { username: "asaf", password: "123", role: "visitor", displayName: "Asaf Galvão", email: "asaf@galvaodrones.com.br", phone: "", profilePic: "https://i.imgur.com/8Yd00YF.png" },
        { username: "analua", password: "123", role: "visitor", displayName: "Ana Lua Galvão", email: "analua@galvaodrones.com.br", phone: "", profilePic: "https://i.imgur.com/8Yd00YF.png" }
    ];

    // Dados de produtos e fornecedores (exemplo)
    let products = [
        { id: "P001", name: "DJI Mini 4 Pro", spec: "Drone compacto com câmera 4K/60fps, detecção de obstáculos omnidirecional, bateria de longa duração (até 34 min). Ideal para viagens e uso recreativo.", salePrice: 6999.00, costPrice: 5500.00, mainSupplierId: "S001", category: "Consumer" },
        { id: "P002", name: "DJI Air 3", spec: "Drone de médio porte com sistema de câmera dupla (wide e tele média 3x), vídeo 4K/60fps HDR, tempo máximo de voo de 46 minutos. Excelente para criadores de conteúdo.", salePrice: 8999.00, costPrice: 7000.00, mainSupplierId: "S001", category: "Consumer" },
        { id: "P003", name: "DJI Mavic 3 Enterprise", spec: "Drone profissional para levantamento e inspeção, câmera grande angular de 20MP, tele câmera com zoom híbrido de 56x, módulo RTK para precisão centimétrica. Essencial para mapeamento e segurança.", salePrice: 35000.00, costPrice: 28000.00, mainSupplierId: "S002", category: "Enterprise" },
        { id: "P004", name: "DJI Agras T40", spec: "Drone agrícola para pulverização e dispersão, capacidade de 40L, sistema de pulverização dupla atomizada, radar de fase ativa e visão binocular. Aumenta a eficiência na agricultura.", salePrice: 120000.00, costPrice: 95000.00, mainSupplierId: "S003", category: "Agriculture" },
        { id: "P005", name: "Bateria DJI Mini 4 Pro", spec: "Bateria de voo inteligente para DJI Mini 4 Pro, capacidade de 2590 mAh, oferece até 34 minutos de voo.", salePrice: 799.00, costPrice: 600.00, mainSupplierId: "S001", category: "Acessórios" },
        { id: "P006", name: "Hélices DJI Air 3 (Par)", spec: "Hélices de baixo ruído para DJI Air 3, design aerodinâmico para voo eficiente e silencioso.", salePrice: 120.00, costPrice: 80.00, mainSupplierId: "S001", category: "Acessórios" },
        { id: "P007", name: "DJI Avata 2", spec: "Drone FPV imersivo com controle intuitivo, vídeo 4K/60fps, protetores de hélice integrados, modo acrobático fácil. Perfeito para voos em primeira pessoa e manobras radicais.", salePrice: 9500.00, costPrice: 7500.00, mainSupplierId: "S001", category: "FPV" },
        { id: "P008", name: "DJI Inspire 3", spec: "Drone cinematográfico full-frame 8K, sistema de câmera Zenmuse X9-8K Air, transmissão de vídeo O3 Pro, multi-direcional sensing. Para produções de alto nível.", salePrice: 75000.00, costPrice: 60000.00, mainSupplierId: "S002", category: "Enterprise" },
        { id: "P009", name: "DJI Matrice 350 RTK", spec: "Plataforma de drone industrial com capacidade de carga de 2.7 kg, resistência a intempéries, tempo de voo de 55 minutos, compatível com diversas cargas úteis. Para missões críticas e inspeções complexas.", salePrice: 90000.00, costPrice: 72000.00, mainSupplierId: "S002", category: "Enterprise" },
        { id: "P010", name: "DJI Agras T25", spec: "Drone agrícola compacto, capacidade de 20L, sistema de pulverização e dispersão, radar omnidirecional. Ideal para pequenas e médias propriedades.", salePrice: 80000.00, costPrice: 64000.00, mainSupplierId: "S003", category: "Agriculture" }
    ];

    let suppliers = [
        { id: "S001", name: "DroneStore Brasil", details: "Distribuidor oficial DJI para linha Consumer e FPV. Ótimos preços e suporte.", payment: "Faturamento 30/60/90, PIX", products: "Drones Consumer, FPV, Acessórios", categories: ["Consumer", "FPV", "Equipamentos", "Pecas"], contacts: [{ type: "WhatsApp", value: "5511987654321", name: "João (Vendas)" }, { type: "Email", value: "vendas@dronestore.com.br", name: "Vendas" }] },
        { id: "S002", name: "TechDrones Pro", details: "Especializado em drones DJI Enterprise e soluções industriais. Suporte técnico avançado.", payment: "Faturamento 45 dias, Boleto", products: "Drones Enterprise, Peças Industriais", categories: ["Enterprise", "Equipamentos", "Pecas"], contacts: [{ type: "WhatsApp", value: "5521998765432", name: "Maria (Enterprise)" }, { type: "Telefone", value: "2133445566", name: "Suporte" }] },
        { id: "S003", name: "AgroDrone Solutions", details: "Foco em drones agrícolas DJI Agras e soluções para o campo. Treinamento e peças.", payment: "Faturamento 60 dias, PIX", products: "Drones Agrícolas, Peças Agrícolas", categories: ["Agriculture", "Equipamentos", "Pecas"], contacts: [{ type: "WhatsApp", value: "5562987651234", name: "Pedro (Agro)" }, { type: "Email", value: "contato@agrodrone.com.br", name: "Geral" }] }
    ];

    let tempUsers = JSON.parse(localStorage.getItem('tempUsers')) || [];

    // Elementos do DOM
    const loginScreen = document.getElementById('login-screen');
    const appScreen = document.getElementById('app-screen');
    const loginButton = document.getElementById('login-button');
    const visitorModeButton = document.getElementById('visitor-mode-button');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginError = document.getElementById('login-error');
    const welcomeMessage = document.getElementById('welcome-message');
    const logoutButton = document.getElementById('logout-button');
    const navButtons = document.querySelectorAll('.nav-button');
    const contentSections = document.querySelectorAll('.content-section');
    const productSearchInput = document.getElementById('product-search');
    const productList = document.getElementById('product-list');
    const generalValorBaseInput = document.getElementById('general-valor-base');
    const generalPaymentMethodSelector = document.getElementById('general-payment-method-selector');
    const generalInstallmentsContainer = document.getElementById('general-installments-container');
    const generalParcelasSelect = document.getElementById('general-parcelas');
    const generalCalculateButton = document.getElementById('general-calculate-button');
    const generalCalculatorResult = document.getElementById('general-calculator-result');
    const generalDiscountOption = document.getElementById('general-discount-option');
    const generalDiscountPercentageInput = document.getElementById('general-discount-percentage');
    const supplierList = document.getElementById('supplier-list');
    const scrollButton = document.getElementById('scroll-to-top');
    const mainContent = document.getElementById('main-content');
    const aiChatButton = document.getElementById('ai-chat-button');
    const aiChatModal = document.getElementById('ai-chat-modal');
    const aiQuestionInput = document.getElementById('ai-question-input');
    const submitAiQuestionButton = document.getElementById('submit-ai-question');
    const aiResponseArea = document.getElementById('ai-response-area');
    const aiLoader = aiChatModal.querySelector('.loader');
    const supplierPasswordModal = document.getElementById('supplier-password-modal');
    const supplierAccessPasswordInput = document.getElementById('supplier-access-password');
    const submitSupplierPasswordButton = document.getElementById('submit-supplier-password');
    const supplierPasswordError = document.getElementById('supplier-password-error');
    const supplierPasswordCloseButton = document.getElementById('supplier-password-close-button');
    const profileIconContainer = document.getElementById('profile-icon-container');
    const profileIcon = document.getElementById('profile-icon');
    const changePasswordModal = document.getElementById('change-password-modal');
    const newPasswordInput = document.getElementById('new-password');
    const confirmNewPasswordInput = document.getElementById('confirm-new-password');
    const submitChangePasswordButton = document.getElementById('submit-change-password');
    const changePasswordError = document.getElementById('change-password-error');
    const changePasswordSuccess = document.getElementById('change-password-success');
    const changePasswordCloseButton = document.getElementById('change-password-close-button');
    const openChangePasswordModalButton = document.getElementById('open-change-password-modal');
    const profileDisplayName = document.getElementById('profile-display-name');
    const profileEmail = document.getElementById('profile-email');
    const profilePhone = document.getElementById('profile-phone');
    const profilePicDisplay = document.getElementById('profile-pic-display');
    const editDisplayNameInput = document.getElementById('edit-display-name');
    const editEmailInput = document.getElementById('edit-email');
    const editPhoneInput = document.getElementById('edit-phone');
    const editProfilePicInput = document.getElementById('edit-profile-pic');
    const uploadProfilePicButton = document.getElementById('upload-profile-pic-button');
    const profileEditForm = document.getElementById('profile-edit-form');
    const profileFeedback = document.getElementById('profile-feedback');
    const whatsappModal = document.getElementById('whatsapp-modal');
    const whatsappMessageInput = document.getElementById('whatsapp-message-input');
    const includeDisplayNameCheckbox = document.getElementById('include-display-name');
    const includeEmailCheckbox = document.getElementById('include-email');
    const includePhoneCheckbox = document.getElementById('include-phone');
    const whatsappDisplayNamePreview = document.getElementById('whatsapp-display-name-preview');
    const whatsappEmailPreview = document.getElementById('whatsapp-email-preview');
    const whatsappPhonePreview = document.getElementById('whatsapp-phone-preview');
    const sendWhatsappButton = document.getElementById('send-whatsapp-button');
    const cancelWhatsappButton = document.getElementById('cancel-whatsapp-button');
    const whatsappCloseButton = document.getElementById('whatsapp-close-button');
    const openBudgetModalButton = document.getElementById('open-budget-modal-button');
    const budgetModal = document.getElementById('budget-modal');
    const budgetCloseButton = document.getElementById('budget-close-button');
    const droneCategoryCheckboxes = document.getElementById('drone-category-checkboxes');
    const itemTypeGroup = document.getElementById('item-type-group');
    const itemTypeCheckboxes = document.getElementById('item-type-checkboxes');
    const equipmentDetailsGroup = document.getElementById('equipment-details-group');
    const equipmentDetailsInput = document.getElementById('equipment-details');
    const sparePartsDetailsGroup = document.getElementById('spare-parts-details-group');
    const sparePartsDetailsInput = document.getElementById('spare-parts-details');
    const supplierSelectGroup = document.getElementById('supplier-select-group');
    const budgetSupplierCheckboxes = document.getElementById('budget-supplier-checkboxes');
    const selectedSupplierContact = document.getElementById('selected-supplier-contact');
    const selectedSupplierNameDisplay = document.getElementById('selected-supplier-name-display');
    const sendBudgetWhatsappButton = document.getElementById('send-budget-whatsapp');
    const openCreateSupplierModalButton = document.getElementById('open-create-supplier-modal-button');
    const manageSupplierModal = document.getElementById('manage-supplier-modal');
    const manageSupplierCloseButton = document.getElementById('manage-supplier-close-button');
    const manageSupplierModalTitle = document.getElementById('manage-supplier-modal-title');
    const manageSupplierForm = document.getElementById('manage-supplier-form');
    const supplierIdToEdit = document.getElementById('supplier-id-to-edit');
    const supplierNameInput = document.getElementById('supplier-name');
    const supplierDetailsInput = document.getElementById('supplier-details');
    const supplierPaymentInput = document.getElementById('supplier-payment');
    const supplierProductsInput = document.getElementById('supplier-products');
    const supplierCategoryCheckboxes = manageSupplierModal.querySelectorAll('input[name="supplier-category"]');
    const supplierContactsContainer = document.getElementById('supplier-contacts-container');
    const addSupplierContactButton = document.getElementById('add-supplier-contact-button');
    const saveSupplierButton = document.getElementById('save-supplier-button');
    const manageSupplierFeedback = document.getElementById('manage-supplier-feedback');
    const openEditSupplierSearchModalButton = document.getElementById('open-edit-supplier-search-modal-button');
    const editSupplierSearchModal = document.getElementById('edit-supplier-search-modal');
    const editSupplierSearchCloseButton = document.getElementById('edit-supplier-search-close-button');
    const editSupplierSearchInputModal = document.getElementById('edit-supplier-search-input-modal');
    const searchSupplierToEditModalButton = document.getElementById('search-supplier-to-edit-modal-button');
    const editSupplierSearchResultsModal = document.getElementById('edit-supplier-search-results-modal');
    const createTempUserForm = document.getElementById('create-temp-user-form');
    const tempUsernameInput = document.getElementById('temp-username');
    const tempPasswordInput = document.getElementById('temp-password');
    const tempDurationSelect = document.getElementById('temp-duration');
    const tempUserFeedback = document.getElementById('temp-user-feedback');
    const tempUserList = document.getElementById('temp-user-list');
    const createProductForm = document.getElementById('create-product-form');
    const newProductNameInput = document.getElementById('new-product-name');
    const newProductSpecInput = document.getElementById('new-product-spec');
    const newProductSalePriceInput = document.getElementById('new-product-sale-price');
    const newProductCostPriceInput = document.getElementById('new-product-cost-price');
    const newProductSupplierSelect = document.getElementById('new-product-supplier');
    const createProductFeedback = document.getElementById('create-product-feedback');
    const editProductSearchInput = document.getElementById('edit-product-search-input');
    const searchProductToEditButton = document.getElementById('search-product-to-edit');
    const editProductSearchResults = document.getElementById('edit-product-search-results');
    const editProductDisplay = document.getElementById('edit-product-display');
    const editProductForm = document.getElementById('edit-product-form');
    const editProductIdInput = document.getElementById('edit-product-id');
    const editProductNameInput = document.getElementById('edit-product-name');
    const editProductSpecInput = document.getElementById('edit-product-spec');
    const editProductSalePriceInput = document.getElementById('edit-product-sale-price');
    const editProductCostPriceInput = document.getElementById('edit-product-cost-price');
    const editProductSupplierSelect = document.getElementById('edit-product-supplier');
    const editProductFeedback = document.getElementById('edit-product-feedback');
    const droneVisitorSearchInput = document.getElementById('drone-visitor-search');
    const droneVisitorList = document.getElementById('drone-visitor-list');
    const navToggleBtn = document.getElementById('nav-toggle-btn');
    const navToggleBtnClose = document.getElementById('nav-toggle-btn-close');
    const nav = document.querySelector('nav');

    // Elementos do novo modal de filtro e ordenação
    const openProductFilterSortModalButton = document.getElementById('open-product-filter-sort-modal');
    const openSupplierFilterSortModalButton = document.getElementById('open-supplier-filter-sort-modal');
    const filterSortModal = document.getElementById('filter-sort-modal');
    const filterSortCloseButton = document.getElementById('filter-sort-close-button');
    const filterSortModalTitle = document.getElementById('filter-sort-modal-title');
    const filterSortSearchInput = document.getElementById('filter-sort-search-input');
    const filterSortOrderButtons = document.getElementById('filter-sort-order-buttons');
    const filterSortCategoryButtons = document.getElementById('filter-sort-category-buttons');
    const applyFilterSortButton = document.getElementById('apply-filter-sort-button');
    const sortOptionsTitle = document.getElementById('sort-options-title');
    const categoryOptionsTitle = document.getElementById('category-options-title');

    let currentFilterTarget = ''; // 'products' or 'suppliers'
    let currentProductFilters = { searchTerm: '', category: '', sortBy: '' };
    let currentSupplierFilters = { searchTerm: '', category: '', sortBy: '' };

    // --- Funções de Utilidade ---
    function showModal(modalElement) { modalElement.style.display = 'block'; }
    function hideModal(modalElement) { modalElement.style.display = 'none'; }
    function formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }

    // Função para exibir mensagens temporárias
    function showFeedback(element, message, isSuccess = true) {
        element.textContent = message;
        element.style.color = isSuccess ? 'var(--secondary-color)' : 'var(--danger-color)';
        element.style.display = 'block';
        setTimeout(() => { element.style.display = 'none'; }, 5000);
    }

    // Função para carregar dados do usuário logado
    function loadUserProfile() {
        if (currentUser) {
            profileDisplayName.textContent = currentUser.displayName;
            profileEmail.textContent = currentUser.email || 'Não informado';
            profilePhone.textContent = currentUser.phone ? `Celular: ${currentUser.phone}` : 'Celular: Não informado';
            profilePicDisplay.src = currentUser.profilePic || "https://i.imgur.com/8Yd00YF.png";
            profileIcon.src = currentUser.profilePic || "https://i.imgur.com/8Yd00YF.png";

            editDisplayNameInput.value = currentUser.displayName;
            editEmailInput.value = currentUser.email;
            editPhoneInput.value = currentUser.phone;

            whatsappDisplayNamePreview.textContent = currentUser.displayName;
            whatsappEmailPreview.textContent = currentUser.email;
            whatsappPhonePreview.textContent = currentUser.phone;
        }
    }

    // Função para popular selects de fornecedores
    function populateSupplierSelects() {
        const supplierOptions = suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        if (newProductSupplierSelect) newProductSupplierSelect.innerHTML = '<option value="">Selecione um fornecedor</option>' + supplierOptions;
        if (editProductSupplierSelect) editProductSupplierSelect.innerHTML = '<option value="">Selecione um fornecedor</option>' + supplierOptions;
    }

    // --- Funções de Login e Navegação ---
    function login(username, password, isVisitor = false) {
        let userFound = users.find(u => u.username === username && u.password === password);
        if (isVisitor) {
            userFound = { username: "visitante", role: "visitor", displayName: "Visitante", profilePic: "https://i.imgur.com/8Yd00YF.png" };
        }

        if (userFound) {
            currentUser = userFound;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loginScreen.style.display = 'none';
            appScreen.style.display = 'block';
            welcomeMessage.textContent = `Olá, ${currentUser.displayName}!`;
            document.body.classList.remove('visitor-mode-bg');
            updateUIBasedOnRole();
            loadUserProfile();
            switchTab('products-section'); // Aba padrão
            aiChatButton.style.display = 'block'; // Mostra o botão da IA após o login
            scrollButton.style.display = 'block'; // Mostra o botão de scroll
        } else {
            loginError.style.display = 'block';
        }
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        appScreen.style.display = 'none';
        loginScreen.style.display = 'block';
        loginError.style.display = 'none';
        usernameInput.value = '';
        passwordInput.value = '';
        document.body.classList.remove('visitor-mode-bg');
        aiChatButton.style.display = 'none'; // Esconde o botão da IA ao deslogar
        scrollButton.style.display = 'none'; // Esconde o botão de scroll
    }

    function updateUIBasedOnRole() {
        const isAdmin = currentUser && currentUser.role === 'admin';
        const isVisitor = currentUser && currentUser.role === 'visitor';

        // Oculta/mostra seções e botões de navegação
        document.getElementById('suppliers-nav-button').classList.toggle('hidden', isVisitor);
        document.getElementById('settings-nav-button').classList.toggle('hidden', isVisitor);
        document.getElementById('profile-nav-button').classList.toggle('hidden', isVisitor); // Perfil sempre visível para usuários logados
        document.getElementById('marketing-nav-button').classList.toggle('hidden', isVisitor);

        // Oculta/mostra sub-itens de configurações
        document.getElementById('manage-users-nav-button').classList.toggle('hidden', !isAdmin);
        document.getElementById('create-product-nav-button').classList.toggle('hidden', !isAdmin);
        document.getElementById('edit-product-nav-button').classList.toggle('hidden', !isAdmin);

        // Oculta/mostra botões específicos de admin/confidencial
        if (document.getElementById('open-budget-modal-button')) document.getElementById('open-budget-modal-button').classList.toggle('hidden', isVisitor);
        if (document.getElementById('open-create-supplier-modal-button')) document.getElementById('open-create-supplier-modal-button').classList.toggle('hidden', isVisitor);
        if (document.getElementById('open-edit-supplier-search-modal-button')) document.getElementById('open-edit-supplier-search-modal-button').classList.toggle('hidden', isVisitor);
        if (document.getElementById('open-supplier-filter-sort-modal')) document.getElementById('open-supplier-filter-sort-modal').classList.toggle('hidden', isVisitor);

        // Ajusta a exibição da seção de fornecedores
        const suppliersSection = document.getElementById('suppliers-section');
        if (suppliersSection) {
            if (isVisitor) {
                suppliersSection.innerHTML = `<h2>Fornecedores</h2><p>Acesso restrito. Por favor, faça login como um usuário autorizado para ver esta seção.</p>`;
            } else if (currentUser.role === 'user') {
                // Usuários "user" podem ver a lista, mas não os botões de gerenciamento
                suppliersSection.innerHTML = `
                    <h2>Fornecedores (Acesso Restrito)</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button id="open-budget-modal-button" class="action-button" style="width: auto;">Fazer Orçamento</button>
                        </div>
                    <button id="open-supplier-filter-sort-modal" class="filter-sort-button">
                        ⚙️ Filtros e Ordenação
                    </button>
                    <div id="supplier-list"></div>
                `;
                // Re-adiciona o event listener para o botão de orçamento
                document.getElementById('open-budget-modal-button').addEventListener('click', () => showModal(budgetModal));
                document.getElementById('open-supplier-filter-sort-modal').addEventListener('click', () => openFilterSortModal('suppliers'));
                renderSuppliers(); // Renderiza a lista de fornecedores
            } else {
                // Admins veem tudo, o HTML já está no estado correto
                renderSuppliers();
            }
        }

        // Se estiver no modo visitante, muda o background
        if (isVisitor) {
            document.body.classList.add('visitor-mode-bg');
            document.getElementById('header-title-container').innerHTML = `<h1>Portal Visitante</h1>`;
            document.getElementById('logout-button').textContent = 'Sair do Modo Visitante';
            document.getElementById('profile-icon-container').style.display = 'none'; // Esconde o ícone de perfil no modo visitante
            document.getElementById('welcome-message').style.display = 'none'; // Esconde a mensagem de boas-vindas no modo visitante
            document.getElementById('cnpj-display-line').innerHTML = `<strong>CNPJ:</strong> <span style="filter: blur(4px);">60.102.179/0001-10</span> (Acesso Restrito)`;
            document.getElementById('company-phone').innerHTML = `<span style="filter: blur(4px);">(62) 3636-0668</span> (Acesso Restrito)`;
            document.getElementById('company-whatsapp-link').href = 'javascript:void(0);'; // Desabilita o link do WhatsApp
            document.getElementById('company-whatsapp-link').style.opacity = 0.5; // Indica que está desabilitado
            document.getElementById('company-whatsapp-link').style.pointerEvents = 'none'; // Impede cliques
        } else {
            document.body.classList.remove('visitor-mode-bg');
            document.getElementById('header-title-container').innerHTML = `<h1>Portal Interno</h1>`;
            document.getElementById('logout-button').textContent = 'Sair';
            document.getElementById('profile-icon-container').style.display = 'flex'; // Mostra o ícone de perfil
            document.getElementById('welcome-message').style.display = 'block'; // Mostra a mensagem de boas-vindas
            document.getElementById('cnpj-display-line').innerHTML = `<strong>CNPJ:</strong> 60.102.179/0001-10`;
            document.getElementById('company-phone').innerHTML = `(62) 3636-0668`;
            document.getElementById('company-whatsapp-link').href = 'https://wa.me/556236360668'; // Reabilita o link do WhatsApp
            document.getElementById('company-whatsapp-link').style.opacity = 1;
            document.getElementById('company-whatsapp-link').style.pointerEvents = 'auto';
        }

        // Renderiza os produtos e drones para garantir que as permissões sejam aplicadas
        renderProducts();
        renderDronesVisitor();
    }

    window.switchTab = function(sectionId) {
        contentSections.forEach(section => { section.classList.remove('active'); });
        navButtons.forEach(button => { button.classList.remove('active'); });
        document.getElementById(sectionId).classList.add('active');
        document.querySelector(`.nav-button[data-section="${sectionId}"]`).classList.add('active');

        // Fecha sub-navs
        document.querySelectorAll('.sub-nav').forEach(sub => sub.style.display = 'none');
        // Abre sub-nav se o botão clicado for de uma sub-nav
        const parentNavButton = document.querySelector(`.nav-button[data-section="${sectionId}"]`);
        if (parentNavButton && parentNavButton.closest('.nav-item-group')) {
            parentNavButton.closest('.nav-item-group').querySelector('.sub-nav').style.display = 'block';
        }

        // Esconde o menu de navegação em telas pequenas após a seleção
        if (window.innerWidth <= 768) {
            nav.classList.remove('nav-open');
        }

        // Lógica específica para a seção de fornecedores
        if (sectionId === 'suppliers-section' && currentUser && currentUser.role === 'user') {
            // Se for um usuário normal, e a seção de fornecedores foi ativada,
            // re-renderiza para garantir que os botões de gerenciamento estejam ocultos.
            updateUIBasedOnRole();
        } else if (sectionId === 'suppliers-section' && currentUser && currentUser.role === 'admin') {
            // Se for admin, renderiza normalmente para mostrar tudo
            renderSuppliers();
        } else if (sectionId === 'suppliers-section' && currentUser && currentUser.role === 'visitor') {
            // Se for visitante, a mensagem de acesso restrito já foi definida em updateUIBasedOnRole
        }

        // Lógica para a seção de perfil
        if (sectionId === 'profile-section') {
            loadUserProfile();
        }

        // Lógica para a seção de configurações
        if (sectionId === 'settings-section') {
            renderSettingsOptions();
        }
    };

    // --- Renderização de Produtos ---
    function renderProducts(filters = currentProductFilters) {
        productList.innerHTML = '';
        let filteredProducts = products;

        if (filters.searchTerm) {
            const searchTermLower = filters.searchTerm.toLowerCase();
            filteredProducts = filteredProducts.filter(p =>
                p.name.toLowerCase().includes(searchTermLower) ||
                p.spec.toLowerCase().includes(searchTermLower)
            );
        }

        if (filters.category) {
            filteredProducts = filteredProducts.filter(p => p.category === filters.category);
        }

        // Ordenação
        if (filters.sortBy === 'name-asc') {
            filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
        } else if (filters.sortBy === 'name-desc') {
            filteredProducts.sort((a, b) => b.name.localeCompare(a.name));
        } else if (filters.sortBy === 'price-asc') {
            filteredProducts.sort((a, b) => a.salePrice - b.salePrice);
        } else if (filters.sortBy === 'price-desc') {
            filteredProducts.sort((a, b) => b.salePrice - a.salePrice);
        }

        if (filteredProducts.length === 0) {
            productList.innerHTML = '<p>Nenhum produto encontrado com os filtros aplicados.</p>';
            return;
        }

        filteredProducts.forEach(product => {
            const card = document.createElement('div');
            card.className = 'card product-card';
            card.innerHTML = `
                <h3>${product.name} <small>(ID: ${product.id})</small></h3>
                <p class="product-spec"><strong>Especificações:</strong> ${product.spec}</p>
                <p class="price"><strong>Preço de Venda:</strong> ${formatCurrency(product.salePrice)}</p>
                ${currentUser && currentUser.role === 'admin' ? `<p class="cost-price"><strong>Preço de Custo:</strong> ${formatCurrency(product.costPrice)}</p>` : ''}
                ${product.mainSupplierId ? `<p class="supplier-info"><strong>Fornecedor Principal:</strong> <a href="#" class="supplier-name-link" data-supplier-id="${product.mainSupplierId}">${suppliers.find(s => s.id === product.mainSupplierId)?.name || 'N/A'}</a></p>` : ''}
                <div class="action-buttons-container">
                    <button class="action-button gemini-button" data-product-name="${product.name}" data-product-spec="${product.spec}">Perguntar à IA</button>
                    ${currentUser && currentUser.role !== 'visitor' ? `
                    <button class="action-button whatsapp-button" data-product-name="${product.name}" data-product-price="${product.salePrice}">Enviar via WhatsApp</button>
                    <button class="action-button calculate-product-btn" data-product-id="${product.id}">Calcular Preço Final</button>
                    ` : ''}
                </div>
                <div class="calculator-container hidden" id="calculator-${product.id}">
                    <h4>Simular Preço Final</h4>
                    <div class="input-group">
                        <label>Forma de Pagamento</label>
                        <div class="payment-method-selector">
                            <input type="radio" id="payment-vista-${product.id}" name="payment-method-${product.id}" value="vista" checked>
                            <label for="payment-vista-${product.id}">À vista</label>
                            <input type="radio" id="payment-parcelado-${product.id}" name="payment-method-${product.id}" value="parcelado">
                            <label for="payment-parcelado-${product.id}">Parcelado</label>
                        </div>
                    </div>
                    <div class="discount-option" id="discount-option-${product.id}">
                        <label for="discount-percentage-${product.id}">Desconto (%):</label>
                        <input type="number" id="discount-percentage-${product.id}" min="0" max="15" value="0">
                    </div>
                    <div class="input-group hidden" id="installments-container-${product.id}">
                        <label for="parcelas-${product.id}">Número de Parcelas</label>
                        <select id="parcelas-${product.id}">
                            <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option>
                        </select>
                    </div>
                    <button class="action-button calculate-btn" data-product-id="${product.id}">Calcular</button>
                    <div class="product-calculator-result" id="product-calculator-result-${product.id}">O resultado da simulação aparecerá aqui.</div>
                </div>
            `;
            productList.appendChild(card);
        });

        // Adiciona event listeners para os botões de calcular preço final
        document.querySelectorAll('.calculate-product-btn').forEach(button => {
            button.onclick = (e) => {
                const productId = e.target.dataset.productId;
                const calculatorContainer = document.getElementById(`calculator-${productId}`);
                calculatorContainer.classList.toggle('hidden');
            };
        });

        // Adiciona event listeners para os botões de rádio de pagamento e desconto
        document.querySelectorAll('input[name^="payment-method-"]').forEach(radio => {
            radio.onchange = (e) => {
                const productId = e.target.name.replace('payment-method-', '');
                const installmentsContainer = document.getElementById(`installments-container-${productId}`);
                const discountOption = document.getElementById(`discount-option-${productId}`);
                if (e.target.value === 'parcelado') {
                    installmentsContainer.classList.remove('hidden');
                    discountOption.classList.add('hidden'); // Oculta desconto para parcelado
                } else {
                    installmentsContainer.classList.add('hidden');
                    discountOption.classList.remove('hidden'); // Mostra desconto para à vista
                }
            };
        });

        // Adiciona event listeners para os botões de cálculo dentro dos cards de produto
        document.querySelectorAll('.calculate-btn').forEach(button => {
            button.onclick = (e) => {
                const productId = e.target.dataset.productId;
                const product = products.find(p => p.id === productId);
                if (!product) return;

                const isParcelado = document.getElementById(`payment-parcelado-${productId}`).checked;
                const parcelas = parseInt(document.getElementById(`parcelas-${productId}`).value);
                const discountPercentage = parseFloat(document.getElementById(`discount-percentage-${productId}`).value);
                const resultDiv = document.getElementById(`product-calculator-result-${productId}`);

                calculateProductPrice(product.salePrice, isParcelado, parcelas, discountPercentage, resultDiv);
            };
        });

        // Adiciona event listeners para os botões "Perguntar à IA"
        document.querySelectorAll('.gemini-button').forEach(button => {
            button.onclick = (e) => {
                const productName = e.target.dataset.productName;
                const productSpec = e.target.dataset.productSpec;
                aiQuestionInput.value = `Quais as principais características do ${productName}? ${productSpec}`;
                showModal(aiChatModal);
            };
        });

        // Adiciona event listeners para os botões "Enviar via WhatsApp"
        document.querySelectorAll('.whatsapp-button').forEach(button => {
            button.onclick = (e) => {
                const productName = e.target.dataset.productName;
                const productPrice = e.target.dataset.productPrice;
                whatsappMessageInput.value = `Olá! Tenho interesse no produto ${productName}, que custa ${formatCurrency(parseFloat(productPrice))}. Poderíamos conversar mais sobre ele?`;
                showModal(whatsappModal);
            };
        });

        // Adiciona event listeners para os links de fornecedores nos produtos
        document.querySelectorAll('.supplier-name-link').forEach(link => {
            link.onclick = (e) => {
                e.preventDefault();
                const supplierId = e.target.dataset.supplierId;
                const supplier = suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    // Navega para a seção de fornecedores e tenta exibir o fornecedor específico
                    switchTab('suppliers-section');
                    // Idealmente, aqui você chamaria uma função para rolar até o fornecedor ou destacá-lo
                    setTimeout(() => {
                        const supplierCard = document.getElementById(`supplier-card-${supplierId}`);
                        if (supplierCard) {
                            supplierCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            supplierCard.style.backgroundColor = '#fffacd'; // Destaca temporariamente
                            setTimeout(() => { supplierCard.style.backgroundColor = ''; }, 3000);
                        }
                    }, 300); // Pequeno atraso para a aba mudar
                }
            };
        });
    }

    // --- Renderização de Fornecedores ---
    function renderSuppliers(filters = currentSupplierFilters) {
        supplierList.innerHTML = '';
        let filteredSuppliers = suppliers;

        if (filters.searchTerm) {
            const searchTermLower = filters.searchTerm.toLowerCase();
            filteredSuppliers = filteredSuppliers.filter(s =>
                s.name.toLowerCase().includes(searchTermLower) ||
                s.details.toLowerCase().includes(searchTermLower) ||
                s.products.toLowerCase().includes(searchTermLower)
            );
        }

        if (filters.category) {
            filteredSuppliers = filteredSuppliers.filter(s => s.categories.includes(filters.category));
        }

        // Ordenação
        if (filters.sortBy === 'name-asc') {
            filteredSuppliers.sort((a, b) => a.name.localeCompare(b.name));
        } else if (filters.sortBy === 'name-desc') {
            filteredSuppliers.sort((a, b) => b.name.localeCompare(a.name));
        }

        if (filteredSuppliers.length === 0) {
            supplierList.innerHTML = '<p>Nenhum fornecedor encontrado com os filtros aplicados.</p>';
            return;
        }

        filteredSuppliers.forEach(supplier => {
            const card = document.createElement('div');
            card.className = 'card supplier-card';
            card.id = `supplier-card-${supplier.id}`; // Adiciona ID para rolagem
            let contactsHtml = '';
            if (supplier.contacts && supplier.contacts.length > 0) {
                contactsHtml = '<h4>Contatos:</h4><ul class="supplier-contacts-list">';
                supplier.contacts.forEach(contact => {
                    contactsHtml += `<li>${contact.name} (${contact.type}): ${contact.value}</li>`;
                });
                contactsHtml += '</ul>';
            }

            card.innerHTML = `
                <h3>${supplier.name}</h3>
                <p><strong>Detalhes:</strong> ${supplier.details}</p>
                <p><strong>Condições de Pagamento:</strong> ${supplier.payment}</p>
                <p><strong>Produtos Principais:</strong> ${supplier.products}</p>
                <p><strong>Categorias:</strong> ${supplier.categories.join(', ')}</p>
                ${contactsHtml}
                ${currentUser && currentUser.role === 'admin' ? `
                    <button class="edit-supplier-button" data-supplier-id="${supplier.id}">Alterar Fornecedor</button>
                ` : ''}
            `;
            supplierList.appendChild(card);
        });

        // Adiciona event listeners para os botões de edição de fornecedor
        document.querySelectorAll('.edit-supplier-button').forEach(button => {
            button.onclick = (e) => {
                const supplierId = e.target.dataset.supplierId;
                openManageSupplierModal('edit', supplierId);
            };
        });
    }

    // --- Renderização de Drones (Modo Visitante) ---
    function renderDronesVisitor() {
        droneVisitorList.innerHTML = '';
        const searchTerm = droneVisitorSearchInput.value.toLowerCase();
        const filteredDrones = products.filter(p =>
            p.category !== 'Acessórios' && // Exclui acessórios
            (p.name.toLowerCase().includes(searchTerm) || p.spec.toLowerCase().includes(searchTerm))
        );

        if (filteredDrones.length === 0) {
            droneVisitorList.innerHTML = '<p>Nenhum drone encontrado.</p>';
            return;
        }

        filteredDrones.forEach(product => {
            const card = document.createElement('div');
            card.className = 'card product-card'; // Reutiliza o estilo de card de produto
            card.innerHTML = `
                <h3>${product.name}</h3>
                <p class="product-spec"><strong>Especificações:</strong> ${product.spec}</p>
                <p class="price"><strong>Preço de Venda:</strong> ${formatCurrency(product.salePrice)}</p>
                <div class="action-buttons-container">
                    <button class="action-button gemini-button" data-product-name="${product.name}" data-product-spec="${product.spec}">Perguntar à IA</button>
                    ${currentUser && currentUser.role !== 'visitor' ? `
                    <button class="action-button whatsapp-button" data-product-name="${product.name}" data-product-price="${product.salePrice}">Enviar via WhatsApp</button>
                    ` : ''}
                </div>
            `;
            droneVisitorList.appendChild(card);
        });

        // Re-adiciona event listeners para os botões "Perguntar à IA" e "Enviar via WhatsApp"
        document.querySelectorAll('#drone-visitor-list .gemini-button').forEach(button => {
            button.onclick = (e) => {
                const productName = e.target.dataset.productName;
                const productSpec = e.target.dataset.productSpec;
                aiQuestionInput.value = `Quais as principais características do ${productName}? ${productSpec}`;
                showModal(aiChatModal);
            };
        });

        if (currentUser && currentUser.role !== 'visitor') {
            document.querySelectorAll('#drone-visitor-list .whatsapp-button').forEach(button => {
                button.onclick = (e) => {
                    const productName = e.target.dataset.productName;
                    const productPrice = e.target.dataset.productPrice;
                    whatsappMessageInput.value = `Olá! Tenho interesse no produto ${productName}, que custa ${formatCurrency(parseFloat(productPrice))}. Poderíamos conversar mais sobre ele?`;
                    showModal(whatsappModal);
                };
            });
        }
    }

    // --- Funções da Calculadora Geral ---
    function calculateGeneralPrice() {
        const baseValue = parseFloat(generalValorBaseInput.value);
        if (isNaN(baseValue) || baseValue <= 0) {
            generalCalculatorResult.innerHTML = '<span style="color: var(--danger-color);">Por favor, insira um valor base válido.</span>';
            return;
        }

        const isParcelado = document.getElementById('general-payment-parcelado').checked;
        const parcelas = parseInt(generalParcelasSelect.value);
        const discountPercentage = parseFloat(generalDiscountPercentageInput.value);

        calculateProductPrice(baseValue, isParcelado, parcelas, discountPercentage, generalCalculatorResult);
    }

    function calculateProductPrice(baseValue, isParcelado, parcelas, discountPercentage, resultElement) {
        let finalPrice = baseValue;
        let resultHtml = '';

        if (isParcelado) {
            // Regra de juros para parcelamento (ex: 2.5% ao mês)
            const taxPerMonth = 0.025;
            const totalTax = taxPerMonth * (parcelas - 1); // Juros a partir da 2ª parcela
            finalPrice = baseValue * (1 + totalTax);

            const valuePerInstallment = finalPrice / parcelas;
            resultHtml = `
                <div class="result-parcelado">
                    <strong>Preço Parcelado (${parcelas}x):</strong> ${formatCurrency(finalPrice)}<br>
                    <strong>Valor por Parcela:</strong> ${formatCurrency(valuePerInstallment)}
                    <small>(Juros de ${((totalTax) * 100).toFixed(1)}% aplicados)</small>
                </div>
            `;
        } else {
            // Pagamento à vista com desconto
            const discountAmount = finalPrice * (discountPercentage / 100);
            finalPrice -= discountAmount;
            resultHtml = `
                <div class="result-vista">
                    <strong>Preço à Vista:</strong> ${formatCurrency(finalPrice)}
                    ${discountPercentage > 0 ? `<small>(Com ${discountPercentage}% de desconto)</small>` : ''}
                </div>
            `;
        }
        resultElement.innerHTML = resultHtml;
    }

    // --- Funções de Gerenciamento de Usuários Temporários ---
    function saveTempUsers() {
        localStorage.setItem('tempUsers', JSON.stringify(tempUsers));
    }

    function renderTempUsers() {
        tempUserList.innerHTML = '';
        if (tempUsers.length === 0) {
            tempUserList.innerHTML = '<p>Nenhum usuário temporário ativo.</p>';
            return;
        }
        tempUsers.forEach(user => {
            const expirationDate = new Date(user.expiresAt);
            const now = new Date();
            const timeLeft = expirationDate.getTime() - now.getTime();
            const hoursLeft = Math.ceil(timeLeft / (1000 * 60 * 60));

            const item = document.createElement('div');
            item.className = 'temp-user-item card';
            item.innerHTML = `
                <div class="user-info">
                    <p><strong>Usuário:</strong> ${user.username}</p>
                    <p><strong>Senha:</strong> ${user.password}</p>
                    <p><small>Expira em: ${expirationDate.toLocaleString('pt-BR')} (${hoursLeft} horas)</small></p>
                </div>
                <div class="user-actions">
                    <button class="delete-btn" data-username="${user.username}">Excluir</button>
                </div>
            `;
            tempUserList.appendChild(item);
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.onclick = (e) => {
                const usernameToDelete = e.target.dataset.username;
                tempUsers = tempUsers.filter(u => u.username !== usernameToDelete);
                saveTempUsers();
                renderTempUsers();
                showFeedback(tempUserFeedback, `Usuário ${usernameToDelete} excluído.`, true);
            };
        });
    }

    function cleanExpiredTempUsers() {
        const now = new Date().getTime();
        const initialLength = tempUsers.length;
        tempUsers = tempUsers.filter(user => new Date(user.expiresAt).getTime() > now);
        if (tempUsers.length < initialLength) {
            saveTempUsers();
            renderTempUsers();
        }
    }

    // --- Funções de Gerenciamento de Produtos (CRUD) ---
    function addProduct(product) {
        products.push(product);
        renderProducts();
        saveData();
    }

    function updateProduct(updatedProduct) {
        const index = products.findIndex(p => p.id === updatedProduct.id);
        if (index !== -1) {
            products[index] = updatedProduct;
            renderProducts();
            saveData();
        }
    }

    function generateProductId() {
        const maxIdNum = products.reduce((max, p) => {
            const num = parseInt(p.id.replace('P', ''));
            return isNaN(num) ? max : Math.max(max, num);
        }, 0);
        return 'P' + String(maxIdNum + 1).padStart(3, '0');
    }

    // --- Funções de Gerenciamento de Fornecedores (CRUD) ---
    function addSupplier(supplier) {
        suppliers.push(supplier);
        renderSuppliers();
        populateSupplierSelects(); // Atualiza selects de produtos
        saveData();
    }

    function updateSupplier(updatedSupplier) {
        const index = suppliers.findIndex(s => s.id === updatedSupplier.id);
        if (index !== -1) {
            suppliers[index] = updatedSupplier;
            renderSuppliers();
            populateSupplierSelects(); // Atualiza selects de produtos
            saveData();
        }
    }

    function generateSupplierId() {
        const maxIdNum = suppliers.reduce((max, s) => {
            const num = parseInt(s.id.replace('S', ''));
            return isNaN(num) ? max : Math.max(max, num);
        }, 0);
        return 'S' + String(maxIdNum + 1).padStart(3, '0');
    }

    function openManageSupplierModal(mode, supplierId = null) {
        manageSupplierForm.reset();
        supplierContactsContainer.innerHTML = ''; // Limpa contatos existentes
        manageSupplierFeedback.style.display = 'none';
        supplierIdToEdit.value = '';

        if (mode === 'create') {
            manageSupplierModalTitle.textContent = 'Criar Novo Fornecedor';
            saveSupplierButton.textContent = 'Salvar Novo Fornecedor';
        } else if (mode === 'edit' && supplierId) {
            manageSupplierModalTitle.textContent = 'Alterar Fornecedor';
            saveSupplierButton.textContent = 'Salvar Alterações';
            const supplier = suppliers.find(s => s.id === supplierId);
            if (supplier) {
                supplierIdToEdit.value = supplier.id;
                supplierNameInput.value = supplier.name;
                supplierDetailsInput.value = supplier.details;
                supplierPaymentInput.value = supplier.payment;
                supplierProductsInput.value = supplier.products;

                supplierCategoryCheckboxes.forEach(checkbox => {
                    checkbox.checked = supplier.categories.includes(checkbox.value);
                });

                if (supplier.contacts && supplier.contacts.length > 0) {
                    supplier.contacts.forEach(contact => addContactField(contact.name, contact.type, contact.value));
                }
            } else {
                showFeedback(manageSupplierFeedback, 'Fornecedor não encontrado.', false);
                return;
            }
        }
        showModal(manageSupplierModal);
    }

    function addContactField(name = '', type = '', value = '') {
        const contactDiv = document.createElement('div');
        contactDiv.className = 'contact-entry';
        contactDiv.innerHTML = `
            <div class="input-group">
                <label>Nome do Contato</label>
                <input type="text" class="contact-name" value="${name}" placeholder="Ex: João Vendas">
            </div>
            <div class="input-group">
                <label>Tipo</label>
                <select class="contact-type">
                    <option value="WhatsApp" ${type === 'WhatsApp' ? 'selected' : ''}>WhatsApp</option>
                    <option value="Telefone" ${type === 'Telefone' ? 'selected' : ''}>Telefone</option>
                    <option value="Email" ${type === 'Email' ? 'selected' : ''}>Email</option>
                </select>
            </div>
            <div class="input-group">
                <label>Valor</label>
                <input type="text" class="contact-value" value="${value}" placeholder="Ex: 5562987654321 ou email@exemplo.com">
            </div>
            <button type="button" class="remove-contact-button">×</button>
        `;
        supplierContactsContainer.appendChild(contactDiv);

        contactDiv.querySelector('.remove-contact-button').onclick = () => contactDiv.remove();
    }

    // --- Funções de Persistência de Dados (localStorage) ---
    function saveData() {
        localStorage.setItem('products', JSON.stringify(products));
        localStorage.setItem('suppliers', JSON.stringify(suppliers));
    }

    function loadData() {
        const storedProducts = localStorage.getItem('products');
        const storedSuppliers = localStorage.getItem('suppliers');
        if (storedProducts) {
            products = JSON.parse(storedProducts);
        }
        if (storedSuppliers) {
            suppliers = JSON.parse(storedSuppliers);
        }
    }

    // --- Funções do Modal de Filtro e Ordenação ---
    function openFilterSortModal(target) {
        currentFilterTarget = target;
        filterSortModalTitle.textContent = target === 'products' ? 'Filtros e Ordenação de Produtos' : 'Filtros e Ordenação de Fornecedores';
        filterSortSearchInput.value = target === 'products' ? currentProductFilters.searchTerm : currentSupplierFilters.searchTerm;

        renderFilterSortOptions(target);
        showModal(filterSortModal);
    }

    function renderFilterSortOptions(target) {
        filterSortOrderButtons.innerHTML = '';
        filterSortCategoryButtons.innerHTML = '';

        let categories = [];
        let sortOptions = [];

        if (target === 'products') {
            categories = [...new Set(products.map(p => p.category))].sort();
            sortOptions = [
                { value: 'name-asc', text: 'Nome (A-Z)' },
                { value: 'name-desc', text: 'Nome (Z-A)' },
                { value: 'price-asc', text: 'Preço (Menor)' },
                { value: 'price-desc', text: 'Preço (Maior)' }
            ];
            sortOptionsTitle.textContent = 'Ordenar Produtos por:';
            categoryOptionsTitle.textContent = 'Filtrar Produtos por Categoria:';
        } else if (target === 'suppliers') {
            categories = [...new Set(suppliers.flatMap(s => s.categories))].sort();
            sortOptions = [
                { value: 'name-asc', text: 'Nome (A-Z)' },
                { value: 'name-desc', text: 'Nome (Z-A)' }
            ];
            sortOptionsTitle.textContent = 'Ordenar Fornecedores por:';
            categoryOptionsTitle.textContent = 'Filtrar Fornecedores por Categoria:';
        }

        // Renderizar botões de ordenação
        sortOptions.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option.text;
            button.dataset.sortBy = option.value;
            button.classList.add('sort-option-button');
            if ((target === 'products' && currentProductFilters.sortBy === option.value) ||
                (target === 'suppliers' && currentSupplierFilters.sortBy === option.value)) {
                button.classList.add('active');
            }
            button.onclick = () => {
                filterSortOrderButtons.querySelectorAll('.sort-option-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                if (target === 'products') currentProductFilters.sortBy = option.value;
                else if (target === 'suppliers') currentSupplierFilters.sortBy = option.value;
            };
            filterSortOrderButtons.appendChild(button);
        });

        // Renderizar botões de categoria
        categories.forEach(category => {
            const button = document.createElement('button');
            button.textContent = category;
            button.dataset.category = category;
            button.classList.add('category-filter-button');
            if ((target === 'products' && currentProductFilters.category === category) ||
                (target === 'suppliers' && currentSupplierFilters.category === category)) {
                button.classList.add('active');
            }
            button.onclick = () => {
                filterSortCategoryButtons.querySelectorAll('.category-filter-button').forEach(btn => btn.classList.remove('active'));
                if ((target === 'products' && currentProductFilters.category === category) ||
                    (target === 'suppliers' && currentSupplierFilters.category === category)) {
                    // Desseleciona se já estiver ativo
                    if (target === 'products') currentProductFilters.category = '';
                    else if (target === 'suppliers') currentSupplierFilters.category = '';
                } else {
                    button.classList.add('active');
                    if (target === 'products') currentProductFilters.category = category;
                    else if (target === 'suppliers') currentSupplierFilters.category = category;
                }
            };
            filterSortCategoryButtons.appendChild(button);
        });
    }

    function applyFilterSort() {
        if (currentFilterTarget === 'products') {
            currentProductFilters.searchTerm = filterSortSearchInput.value.trim();
            renderProducts(currentProductFilters);
        } else if (currentFilterTarget === 'suppliers') {
            currentSupplierFilters.searchTerm = filterSortSearchInput.value.trim();
            renderSuppliers(currentSupplierFilters);
        }
        hideModal(filterSortModal);
    }

    // --- Event Listeners ---
    loginButton.addEventListener('click', () => login(usernameInput.value, passwordInput.value));
    visitorModeButton.addEventListener('click', () => {
        login("visitante", "", true); // Login como visitante
        document.body.classList.add('visitor-mode-bg'); // Adiciona a classe para o background
    });
    logoutButton.addEventListener('click', logout);

    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            const sectionId = button.dataset.section;
            switchTab(sectionId);
        });
    });

    productSearchInput.addEventListener('input', () => {
        currentProductFilters.searchTerm = productSearchInput.value.trim();
        renderProducts(currentProductFilters);
    });

    generalPaymentMethodSelector.addEventListener('change', (e) => {
        if (e.target.value === 'parcelado') {
            generalInstallmentsContainer.classList.remove('hidden');
            generalDiscountOption.classList.add('hidden');
        } else {
            generalInstallmentsContainer.classList.add('hidden');
            generalDiscountOption.classList.remove('hidden');
        }
    });
    generalCalculateButton.addEventListener('click', calculateGeneralPrice);

    // Scroll to top button
    mainContent.onscroll = function() {
        if (mainContent.scrollTop > 200) {
            scrollButton.style.display = "block";
        } else {
            scrollButton.style.display = "none";
        }
    };
    scrollButton.addEventListener('click', () => {
        mainContent.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // AI Chat Modal
    aiChatButton.addEventListener('click', () => {
        aiResponseArea.innerHTML = ''; // Limpa a resposta anterior
        aiQuestionInput.value = ''; // Limpa a pergunta anterior
        showModal(aiChatModal);
    });
    aiChatModal.querySelector('.close-button').addEventListener('click', () => hideModal(aiChatModal));
    submitAiQuestionButton.addEventListener('click', async () => {
        const question = aiQuestionInput.value.trim();
        if (!question) {
            aiResponseArea.innerHTML = '<span style="color: var(--danger-color);">Por favor, digite sua pergunta.</span>';
            return;
        }

        aiResponseArea.innerHTML = ''; // Limpa respostas anteriores
        aiLoader.style.display = 'block'; // Mostra o loader
        submitAiQuestionButton.disabled = true; // Desabilita o botão

        try {
            // Simulação de resposta da IA
            const response = await new Promise(resolve => setTimeout(() => {
                resolve(`Olá! Para a pergunta "${question}", a IA da Galvão Drones está processando...
                \n\nNo momento, esta é uma simulação. Em breve, teremos uma IA de verdade para te ajudar com todas as suas dúvidas sobre drones e produtos!`);
            }, 2000)); // Simula um atraso de 2 segundos

            aiResponseArea.innerHTML = response;
        } catch (error) {
            aiResponseArea.innerHTML = `<span style="color: var(--danger-color);">Erro ao processar a pergunta da IA. Tente novamente.</span>`;
            console.error("Erro na IA:", error);
        } finally {
            aiLoader.style.display = 'none'; // Esconde o loader
            submitAiQuestionButton.disabled = false; // Habilita o botão
        }
    });

    // Supplier Password Modal
    document.getElementById('suppliers-nav-button').addEventListener('click', (e) => {
        if (currentUser && currentUser.role === 'user') {
            e.preventDefault(); // Impede a mudança de aba imediata
            showModal(supplierPasswordModal);
        }
    });
    supplierPasswordCloseButton.addEventListener('click', () => {
        hideModal(supplierPasswordModal);
        supplierAccessPasswordInput.value = '';
        supplierPasswordError.style.display = 'none';
    });
    submitSupplierPasswordButton.addEventListener('click', () => {
        if (supplierAccessPasswordInput.value === 'galvao2025') { // Senha fixa para exemplo
            hideModal(supplierPasswordModal);
            supplierPasswordError.style.display = 'none';
            switchTab('suppliers-section');
            renderSuppliers(); // Renderiza os fornecedores após o acesso
        } else {
            supplierPasswordError.style.display = 'block';
        }
    });

    // Profile and Change Password Modals
    profileIconContainer.addEventListener('click', () => switchTab('profile-section'));
    openChangePasswordModalButton.addEventListener('click', () => {
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
        changePasswordError.style.display = 'none';
        changePasswordSuccess.style.display = 'none';
        showModal(changePasswordModal);
    });
    changePasswordCloseButton.addEventListener('click', () => hideModal(changePasswordModal));
    submitChangePasswordButton.addEventListener('click', () => {
        const newPass = newPasswordInput.value;
        const confirmPass = confirmNewPasswordInput.value;

        if (newPass.length < 6 || newPass !== confirmPass) {
            changePasswordError.style.display = 'block';
            changePasswordSuccess.style.display = 'none';
        } else {
            // Simula a alteração da senha
            if (currentUser) {
                currentUser.password = newPass;
                // Encontra o usuário na lista de usuários e atualiza a senha
                const userIndex = users.findIndex(u => u.username === currentUser.username);
                if (userIndex !== -1) {
                    users[userIndex].password = newPass;
                }
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showFeedback(profileFeedback, 'Senha alterada com sucesso!', true);
            }
            changePasswordError.style.display = 'none';
            changePasswordSuccess.style.display = 'block';
            setTimeout(() => hideModal(changePasswordModal), 2000);
        }
    });

    profileEditForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (currentUser) {
            currentUser.displayName = editDisplayNameInput.value;
            currentUser.email = editEmailInput.value;
            currentUser.phone = editPhoneInput.value;

            // Atualiza na lista de usuários principal
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex] = { ...users[userIndex], ...currentUser };
            }
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loadUserProfile(); // Recarrega para atualizar a UI
            showFeedback(profileFeedback, 'Perfil atualizado com sucesso!', true);
        }
    });

    uploadProfilePicButton.addEventListener('click', () => {
        if (editProfilePicInput.files && editProfilePicInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgUrl = e.target.result;
                if (currentUser) {
                    currentUser.profilePic = imgUrl;
                    const userIndex = users.findIndex(u => u.username === currentUser.username);
                    if (userIndex !== -1) {
                        users[userIndex].profilePic = imgUrl;
                    }
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    loadUserProfile();
                    showFeedback(profileFeedback, 'Foto de perfil atualizada!', true);
                }
            };
            reader.readAsDataURL(editProfilePicInput.files[0]);
        } else {
            showFeedback(profileFeedback, 'Por favor, selecione uma imagem.', false);
        }
    });

    // WhatsApp Modal
    whatsappCloseButton.addEventListener('click', () => hideModal(whatsappModal));
    sendWhatsappButton.addEventListener('click', () => {
        let message = whatsappMessageInput.value;
        const includeName = includeDisplayNameCheckbox.checked;
        const includeEmail = includeEmailCheckbox.checked;
        const includePhone = includePhoneCheckbox.checked;

        let profileInfo = [];
        if (includeName && currentUser.displayName) profileInfo.push(`Nome: ${currentUser.displayName}`);
        if (includeEmail && currentUser.email) profileInfo.push(`Email: ${currentUser.email}`);
        if (includePhone && currentUser.phone) profileInfo.push(`Celular: ${currentUser.phone}`);

        if (profileInfo.length > 0) {
            message += `\n\nMeus dados para contato:\n${profileInfo.join('\n')}`;
        }

        const whatsappUrl = `https://wa.me/556236360668?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        hideModal(whatsappModal);
    });

    // Budget Modal
    openBudgetModalButton.addEventListener('click', () => {
        budgetModal.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        equipmentDetailsInput.value = '';
        sparePartsDetailsInput.value = '';
        itemTypeGroup.classList.add('hidden');
        equipmentDetailsGroup.classList.add('hidden');
        sparePartsDetailsGroup.classList.add('hidden');
        supplierSelectGroup.classList.add('hidden');
        selectedSupplierContact.classList.add('hidden');
        budgetSupplierCheckboxes.innerHTML = ''; // Limpa fornecedores

        showModal(budgetModal);
    });
    budgetCloseButton.addEventListener('click', () => hideModal(budgetModal));

    // Lógica de exibição de campos no modal de orçamento
    droneCategoryCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const anyCategorySelected = Array.from(droneCategoryCheckboxes.querySelectorAll('input[type="checkbox"]')).some(cb => cb.checked);
            itemTypeGroup.classList.toggle('hidden', !anyCategorySelected);
            if (!anyCategorySelected) {
                itemTypeCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                equipmentDetailsGroup.classList.add('hidden');
                sparePartsDetailsGroup.classList.add('hidden');
                supplierSelectGroup.classList.add('hidden');
                selectedSupplierContact.classList.add('hidden');
            }
        });
    });

    itemTypeCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const equipmentSelected = itemTypeCheckboxes.querySelector('input[value="Equipamentos"]').checked;
            const piecesSelected = itemTypeCheckboxes.querySelector('input[value="Pecas"]').checked;

            equipmentDetailsGroup.classList.toggle('hidden', !equipmentSelected);
            sparePartsDetailsGroup.classList.toggle('hidden', !piecesSelected);

            const anyItemSelected = equipmentSelected || piecesSelected;
            supplierSelectGroup.classList.toggle('hidden', !anyItemSelected);

            if (anyItemSelected) {
                // Popula os checkboxes de fornecedores com base nas categorias selecionadas
                const selectedCategories = Array.from(droneCategoryCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                const selectedItemTypes = Array.from(itemTypeCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                const relevantCategories = [...selectedCategories, ...selectedItemTypes];

                const filteredSuppliers = suppliers.filter(supplier =>
                    relevantCategories.some(cat => supplier.categories.includes(cat))
                );

                budgetSupplierCheckboxes.innerHTML = filteredSuppliers.map(s => `
                    <label>
                        <input type="checkbox" name="budget-supplier" value="${s.id}"> ${s.name}
                    </label>
                `).join('');

                // Adiciona listener para os checkboxes de fornecedor para exibir o contato
                budgetSupplierCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const selectedSuppliers = Array.from(budgetSupplierCheckboxes.querySelectorAll('input[type="checkbox"]:checked'));
                        if (selectedSuppliers.length === 1) {
                            const supplierId = selectedSuppliers[0].value;
                            const supplier = suppliers.find(s => s.id === supplierId);
                            if (supplier) {
                                selectedSupplierNameDisplay.textContent = supplier.name;
                                const whatsappContact = supplier.contacts.find(c => c.type === 'WhatsApp');
                                if (whatsappContact) {
                                    sendBudgetWhatsappButton.href = `https://wa.me/${whatsappContact.value}?text=Olá! Gostaria de um orçamento para...`; // Texto inicial será preenchido depois
                                    selectedSupplierContact.classList.remove('hidden');
                                } else {
                                    selectedSupplierContact.classList.add('hidden');
                                }
                            }
                        } else {
                            selectedSupplierContact.classList.add('hidden');
                        }
                    });
                });
            } else {
                budgetSupplierCheckboxes.innerHTML = '';
                selectedSupplierContact.classList.add('hidden');
            }
        });
    });

    sendBudgetWhatsappButton.addEventListener('click', (e) => {
        e.preventDefault();
        const selectedSupplierId = budgetSupplierCheckboxes.querySelector('input[name="budget-supplier"]:checked')?.value;
        if (!selectedSupplierId) {
            alert('Por favor, selecione um fornecedor para enviar o orçamento.');
            return;
        }

        const supplier = suppliers.find(s => s.id === selectedSupplierId);
        if (!supplier) return;

        const whatsappContact = supplier.contacts.find(c => c.type === 'WhatsApp');
        if (!whatsappContact) {
            alert('O fornecedor selecionado não possui um contato de WhatsApp cadastrado.');
            return;
        }

        const selectedCategories = Array.from(droneCategoryCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        const equipmentDetails = equipmentDetailsInput.value.trim();
        const sparePartsDetails = sparePartsDetailsInput.value.trim();

        let messageBody = `Olá, ${supplier.name}! Gostaria de solicitar um orçamento para os seguintes itens:\n\n`;

        if (selectedCategories.length > 0) {
            messageBody += `* Categorias de Drones: ${selectedCategories.join(', ')}\n`;
        }
        if (equipmentDetails) {
            messageBody += `* Equipamentos: ${equipmentDetails}\n`;
        }
        if (sparePartsDetails) {
            messageBody += `* Peças: ${sparePartsDetails}\n`;
        }

        messageBody += `\nAguardo seu retorno.`;

        const whatsappUrl = `https://wa.me/${whatsappContact.value}?text=${encodeURIComponent(messageBody)}`;
        window.open(whatsappUrl, '_blank');
        hideModal(budgetModal);
    });

    // Manage Supplier Modals (Create/Edit)
    openCreateSupplierModalButton.addEventListener('click', () => openManageSupplierModal('create'));
    manageSupplierCloseButton.addEventListener('click', () => hideModal(manageSupplierModal));
    addSupplierContactButton.addEventListener('click', () => addContactField());

    manageSupplierForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const mode = supplierIdToEdit.value ? 'edit' : 'create';
        const id = supplierIdToEdit.value || generateSupplierId();
        const name = supplierNameInput.value.trim();
        const details = supplierDetailsInput.value.trim();
        const payment = supplierPaymentInput.value.trim();
        const products = supplierProductsInput.value.trim();
        const categories = Array.from(supplierCategoryCheckboxes).filter(cb => cb.checked).map(cb => cb.value);

        const contacts = [];
        supplierContactsContainer.querySelectorAll('.contact-entry').forEach(contactDiv => {
            const contactName = contactDiv.querySelector('.contact-name').value.trim();
            const contactType = contactDiv.querySelector('.contact-type').value;
            const contactValue = contactDiv.querySelector('.contact-value').value.trim();
            if (contactName && contactValue) {
                contacts.push({ name: contactName, type: contactType, value: contactValue });
            }
        });

        if (!name) {
            showFeedback(manageSupplierFeedback, 'O nome do fornecedor é obrigatório.', false);
            return;
        }

        const newSupplier = { id, name, details, payment, products, categories, contacts };

        if (mode === 'create') {
            addSupplier(newSupplier);
            showFeedback(manageSupplierFeedback, 'Fornecedor criado com sucesso!', true);
        } else {
            updateSupplier(newSupplier);
            showFeedback(manageSupplierFeedback, 'Fornecedor atualizado com sucesso!', true);
        }
        setTimeout(() => hideModal(manageSupplierModal), 1500);
    });

    // Edit Supplier Search Modal
    openEditSupplierSearchModalButton.addEventListener('click', () => {
        editSupplierSearchInputModal.value = '';
        editSupplierSearchResultsModal.innerHTML = '';
        showModal(editSupplierSearchModal);
    });
    editSupplierSearchCloseButton.addEventListener('click', () => hideModal(editSupplierSearchModal));

    searchSupplierToEditModalButton.addEventListener('click', () => {
        const searchTerm = editSupplierSearchInputModal.value.trim().toLowerCase();
        editSupplierSearchResultsModal.innerHTML = '';
        if (!searchTerm) {
            editSupplierSearchResultsModal.innerHTML = '<p>Por favor, digite um nome para buscar.</p>';
            return;
        }

        const results = suppliers.filter(s => s.name.toLowerCase().includes(searchTerm));
        if (results.length === 0) {
            editSupplierSearchResultsModal.innerHTML = '<p>Nenhum fornecedor encontrado.</p>';
            return;
        }

        const ul = document.createElement('ul');
        results.forEach(s => {
            const li = document.createElement('li');
            li.textContent = `${s.name} (ID: ${s.id})`;
            li.dataset.supplierId = s.id;
            li.onclick = () => {
                hideModal(editSupplierSearchModal);
                openManageSupplierModal('edit', s.id);
            };
            ul.appendChild(li);
        });
        editSupplierSearchResultsModal.appendChild(ul);
    });

    // Manage Temp Users
    createTempUserForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = tempUsernameInput.value.trim();
        const password = tempPasswordInput.value.trim();
        const durationHours = parseInt(tempDurationSelect.value);

        if (!username || !password) {
            showFeedback(tempUserFeedback, 'Usuário e senha são obrigatórios.', false);
            return;
        }
        if (users.some(u => u.username === username) || tempUsers.some(u => u.username === username)) {
            showFeedback(tempUserFeedback, 'Nome de usuário já existe.', false);
            return;
        }

        const expiresAt = new Date(new Date().getTime() + durationHours * 60 * 60 * 1000).toISOString();
        const newTempUser = { username, password, role: "temp", expiresAt };
        tempUsers.push(newTempUser);
        saveTempUsers();
        renderTempUsers();
        showFeedback(tempUserFeedback, `Usuário temporário "${username}" criado com sucesso!`, true);
        createTempUserForm.reset();
    });

    // Create Product
    createProductForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newProduct = {
            id: generateProductId(),
            name: newProductNameInput.value.trim(),
            spec: newProductSpecInput.value.trim(),
            salePrice: parseFloat(newProductSalePriceInput.value),
            costPrice: parseFloat(newProductCostPriceInput.value),
            mainSupplierId: newProductSupplierSelect.value,
            category: "Outros" // Defina uma categoria padrão ou adicione um campo para isso
        };

        if (!newProduct.name || isNaN(newProduct.salePrice) || newProduct.salePrice <= 0) {
            showFeedback(createProductFeedback, 'Nome e Preço de Venda válidos são obrigatórios.', false);
            return;
        }

        addProduct(newProduct);
        showFeedback(createProductFeedback, `Produto "${newProduct.name}" criado com sucesso!`, true);
        createProductForm.reset();
    });

    // Edit Product
    searchProductToEditButton.addEventListener('click', () => {
        const searchTerm = editProductSearchInput.value.trim().toLowerCase();
        editProductSearchResults.innerHTML = '';
        editProductDisplay.innerHTML = '';
        editProductForm.classList.add('hidden');
        editProductFeedback.style.display = 'none';

        if (!searchTerm) {
            editProductSearchResults.innerHTML = '<p>Por favor, digite o ID ou nome do produto.</p>';
            return;
        }

        const results = products.filter(p =>
            p.id.toLowerCase().includes(searchTerm) ||
            p.name.toLowerCase().includes(searchTerm)
        );

        if (results.length === 0) {
            editProductSearchResults.innerHTML = '<p>Nenhum produto encontrado.</p>';
            return;
        }

        if (results.length === 1) {
            loadProductForEdit(results[0].id);
        } else {
            const ul = document.createElement('ul');
            results.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.name} (ID: ${p.id})`;
                li.style.cursor = 'pointer';
                li.style.textDecoration = 'underline';
                li.onclick = () => loadProductForEdit(p.id);
                ul.appendChild(li);
            });
            editProductSearchResults.appendChild(ul);
        }
    });

    function loadProductForEdit(productId) {
        const product = products.find(p => p.id === productId);
        if (product) {
            editProductIdInput.value = product.id;
            editProductNameInput.value = product.name;
            editProductSpecInput.value = product.spec;
            editProductSalePriceInput.value = product.salePrice;
            editProductCostPriceInput.value = product.costPrice;
            editProductSupplierSelect.value = product.mainSupplierId || '';
            editProductDisplay.innerHTML = ''; // Limpa a mensagem de busca
            editProductForm.classList.remove('hidden');
        } else {
            editProductDisplay.innerHTML = '<p style="color: var(--danger-color);">Produto não encontrado para edição.</p>';
            editProductForm.classList.add('hidden');
        }
    }

    editProductForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const updatedProduct = {
            id: editProductIdInput.value,
            name: editProductNameInput.value.trim(),
            spec: editProductSpecInput.value.trim(),
            salePrice: parseFloat(editProductSalePriceInput.value),
            costPrice: parseFloat(editProductCostPriceInput.value),
            mainSupplierId: editProductSupplierSelect.value,
            category: products.find(p => p.id === editProductIdInput.value)?.category || "Outros" // Mantém a categoria existente
        };

        if (!updatedProduct.name || isNaN(updatedProduct.salePrice) || updatedProduct.salePrice <= 0) {
            showFeedback(editProductFeedback, 'Nome e Preço de Venda válidos são obrigatórios.', false);
            return;
        }

        updateProduct(updatedProduct);
        showFeedback(editProductFeedback, `Produto "${updatedProduct.name}" atualizado com sucesso!`, true);
        editProductForm.classList.add('hidden'); // Esconde o formulário após salvar
        editProductSearchInput.value = ''; // Limpa a busca
        editProductSearchResults.innerHTML = ''; // Limpa resultados da busca
    });

    // Drone Visitor Search
    droneVisitorSearchInput.addEventListener('input', renderDronesVisitor);

    // Nav Toggle for Mobile
    navToggleBtn.addEventListener('click', () => {
        nav.classList.add('nav-open');
    });
    navToggleBtnClose.addEventListener('click', () => {
        nav.classList.remove('nav-open');
    });

    // Configurações - Renderiza as opções
    function renderSettingsOptions() {
        const settingsGrid = document.getElementById('settings-options-grid');
        settingsGrid.innerHTML = ''; // Limpa opções anteriores

        const options = [
            { id: 'manage-users-nav-button', title: 'Gerir Usuários', description: 'Crie e gerencie acessos temporários para a equipe.', role: 'admin' },
            { id: 'create-product-nav-button', title: 'Criar Produto', description: 'Adicione novos produtos ao catálogo da Galvão Drones.', role: 'admin' },
            { id: 'edit-product-nav-button', title: 'Alterar Produto', description: 'Edite informações de produtos existentes.', role: 'admin' },
            { id: 'profile-nav-button', title: 'Meu Perfil', description: 'Visualize e edite suas informações pessoais.', role: 'user' }
        ];

        options.forEach(option => {
            // Verifica se o usuário tem permissão para ver esta opção
            if (currentUser && (currentUser.role === 'admin' || (option.role === 'user' && currentUser.role !== 'visitor'))) {
                const card = document.createElement('div');
                card.className = 'card info-card';
                card.innerHTML = `
                    <h3>${option.title}</h3>
                    <p>${option.description}</p>
                    <button class="action-button" style="width: auto; margin-top: 15px;" onclick="window.switchTab('${document.getElementById(option.id).dataset.section}')">Acessar</button>
                `;
                settingsGrid.appendChild(card);
            }
        });
    }

    // --- Event Listeners para o Modal de Filtro e Ordenação ---
    openProductFilterSortModalButton.addEventListener('click', () => openFilterSortModal('products'));
    openSupplierFilterSortModalButton.addEventListener('click', () => {
        // Verifica a permissão antes de abrir o modal de filtros de fornecedores
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'user')) {
            openFilterSortModal('suppliers');
        } else {
            showModal(supplierPasswordModal); // Redireciona para o modal de senha se não for admin/user
        }
    });

    filterSortCloseButton.addEventListener('click', () => hideModal(filterSortModal));
    applyFilterSortButton.addEventListener('click', applyFilterSort);

    // Inicialização
    loadData();
    populateSupplierSelects();
    cleanExpiredTempUsers(); // Limpa usuários expirados ao carregar

    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        loginScreen.style.display = 'none';
        appScreen.style.display = 'block';
        welcomeMessage.textContent = `Olá, ${currentUser.displayName}!`;
        updateUIBasedOnRole();
        loadUserProfile();
        switchTab('products-section'); // Aba padrão ao recarregar
        aiChatButton.style.display = 'block'; // Mostra o botão da IA se já logado
        scrollButton.style.display = 'block'; // Mostra o botão de scroll se já logado
    } else {
        loginScreen.style.display = 'block';
        appScreen.style.display = 'none';
    }

    // Renderiza a lista de produtos inicialmente
    renderProducts();
    renderSuppliers();
    renderTempUsers();
    renderDronesVisitor();
};
